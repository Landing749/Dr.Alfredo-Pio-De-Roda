<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrollment Admin Dashboard</title>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Quill.js for Rich Text Editing -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- Firebase SDK (Compat version for Realtime Database) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for webkit */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        /* Quill Overrides for rounded corners */
        .ql-toolbar.ql-snow {
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
            border-color: #e2e8f0;
        }
        .ql-container.ql-snow {
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            border-color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
        }
    </style>
    <style>@view-transition { navigation: auto; }</style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-30 border-b border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-inner overflow-hidden p-1">
                        <!-- Updated Logo from GitHub -->
                        <img src="https://raw.githubusercontent.com/Landing749/Dr.Alfredo-Pio-De-Roda/main/school-logo.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 id="dashboard-title" class="text-xl font-bold tracking-tight">Enrollment Admin</h1>
                        <p id="school-name" class="text-slate-400 text-xs font-medium">Dr. Alfredo Pio De Roda Elementary School</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button id="refresh-btn" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-200 px-4 py-2 rounded-md text-sm font-medium transition-colors border border-slate-700">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Refresh
                    </button>
                    <button id="export-btn" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 space-y-6">
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Total -->
            <div class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-semibold uppercase tracking-wider">Total Enrollments</p>
                    <p id="total-count" class="text-2xl font-bold text-slate-800 mt-1">0</p>
                </div>
                <div class="p-3 bg-blue-50 rounded-lg">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
            </div>

            <!-- Pending -->
            <div class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-semibold uppercase tracking-wider">Pending Review</p>
                    <p id="pending-count" class="text-2xl font-bold text-amber-600 mt-1">0</p>
                </div>
                <div class="p-3 bg-amber-50 rounded-lg">
                    <svg class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>

            <!-- Approved -->
            <div class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-semibold uppercase tracking-wider">Approved</p>
                    <p id="approved-count" class="text-2xl font-bold text-emerald-600 mt-1">0</p>
                </div>
                <div class="p-3 bg-emerald-50 rounded-lg">
                    <svg class="h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>

            <!-- Weekly -->
            <div class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-semibold uppercase tracking-wider">This Week</p>
                    <p id="week-count" class="text-2xl font-bold text-indigo-600 mt-1">0</p>
                </div>
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <svg class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                <!-- Tabs -->
                <div class="flex flex-wrap gap-2" id="filter-tabs">
                    <button class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-slate-900 text-white shadow-sm" data-status="all">All</button>
                    <button class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-white text-slate-600 border border-slate-200 hover:bg-slate-50" data-status="pending">Pending</button>
                    <button class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-white text-slate-600 border border-slate-200 hover:bg-slate-50" data-status="approved">Approved</button>
                    <button class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-white text-slate-600 border border-slate-200 hover:bg-slate-50" data-status="contacted">Contacted</button>
                    <button class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-white text-slate-600 border border-slate-200 hover:bg-slate-50" data-status="rejected">Rejected</button>
                </div>

                <!-- Search & Grade -->
                <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input type="text" id="search-input" class="block w-full pl-9 pr-3 py-2 border border-slate-300 rounded-md leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Search students...">
                    </div>
                    <select id="grade-filter" class="block w-full sm:w-40 pl-3 pr-8 py-2 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 rounded-md bg-white">
                        <option value="">All Grades</option>
                        <option value="kindergarten">Kindergarten</option>
                        <option value="1st">1st Grade</option>
                        <option value="2nd">2nd Grade</option>
                        <option value="3rd">3rd Grade</option>
                        <option value="4th">4th Grade</option>
                        <option value="5th">5th Grade</option>
                        <option value="6th">6th Grade</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Data Display -->
        <div class="relative min-h-[400px]">
            <!-- Loading -->
            <div id="loading-state" class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm z-10 rounded-xl">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-3"></div>
                <p class="text-slate-500 text-sm font-medium">Loading...</p>
            </div>

            <!-- Table -->
            <div id="enrollments-container" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Student</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Contact</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Grade</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Control #</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Queue</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="enrollments-tbody" class="bg-white divide-y divide-slate-200">
                            <!-- Rows inserted via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 bg-white rounded-xl border border-slate-200 border-dashed">
                <div class="p-3 bg-slate-50 rounded-full mb-3">
                    <svg class="h-8 w-8 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h3 class="text-base font-semibold text-slate-800">No Enrollments Found</h3>
                <p class="text-slate-500 text-sm mt-1">Try adjusting your filters or search terms.</p>
                <button onclick="document.querySelector('[data-status=all]').click()" class="mt-4 text-blue-600 hover:text-blue-700 text-sm font-medium">Clear Filters</button>
            </div>
        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop"></div>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="relative inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" id="modal-panel">
                <div class="bg-white px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="text-lg font-bold text-slate-800" id="modal-title">Application Details</h3>
                    <button id="close-detail-modal" class="text-slate-400 hover:text-slate-500 focus:outline-none transition-colors"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                    <div id="modal-content" class="space-y-6"></div>
                </div>
                <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex flex-col sm:flex-row sm:justify-end gap-3">
                    <button id="modal-reject" class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-rose-300 shadow-sm text-sm font-medium rounded-md text-rose-700 bg-white hover:bg-rose-50 focus:outline-none transition-colors">
                        Reject
                    </button>
                    <button id="modal-contact" class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-blue-300 shadow-sm text-sm font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 focus:outline-none transition-colors">
                        Mark Contacted
                    </button>
                    <button id="modal-approve" class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none transition-colors">
                        Approve Enrollment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Brevo Email Modal -->
    <div id="email-modal" class="fixed inset-0 z-[60] overflow-y-auto hidden" aria-labelledby="email-modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0" id="email-backdrop"></div>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="relative inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" id="email-panel">
                <div class="bg-blue-600 px-6 py-4 flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <span id="email-modal-title">Compose Email</span>
                    </h3>
                    <button id="close-email-modal" class="text-blue-100 hover:text-white focus:outline-none transition-colors"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
                
                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    Action: <strong id="email-action-badge" class="uppercase"></strong>. This email will be sent to the guardian.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden config fields for cleanliness, can be shown if needed -->
                    <div class="hidden">
                        <input type="password" id="brevo-api-key" placeholder="xkeysib-..." class="block w-full">
                        <input type="email" id="email-from" class="block w-full">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">To</label>
                            <input type="text" id="email-to" readonly class="block w-full px-3 py-2 border border-slate-300 rounded-md bg-slate-100 text-slate-600 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Recipient Name</label>
                            <input type="text" id="email-name" readonly class="block w-full px-3 py-2 border border-slate-300 rounded-md bg-slate-100 text-slate-600 sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Subject</label>
                        <input type="text" id="email-subject" class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Message Body</label>
                        <!-- Quill Editor Container -->
                        <div class="bg-white rounded-md shadow-sm border border-slate-300">
                            <div id="editor-container" class="h-64 font-sans"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex flex-col sm:flex-row justify-end gap-3">
                    <button id="email-mark-only" class="px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none transition-colors">
                        Update Status (No Email)
                    </button>
                    <button id="email-send" class="flex items-center justify-center gap-2 px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none transition-colors">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                        <span id="email-send-text">Send & Update Status</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // CONFIGURATION (HARDCODED FOR PRODUCTION)
        // ------------------------------------------------------------------
        const config = {
            firebase: {
                apiKey: "AIzaSyB6FAMgqHcccsqce4R5nd8y0YVggc3aHbY",
                authDomain: "clinique-parfum.firebaseapp.com",
                databaseURL: "https://clinique-parfum-default-rtdb.firebaseio.com",
                projectId: "clinique-parfum",
                storageBucket: "clinique-parfum.firebasestorage.app",
                messagingSenderId: "569473208892",
                appId: "1:569473208892:web:f009390a8631fc164ce939",
                measurementId: "G-XW3R3D64PR"
            },
            email: {
                senderName: "Dr. Alfredo Pio De Roda Elementary School",
                senderEmail: "globalinsightnewsmain@gmail.com"
            }
        };

        // ------------------------------------------------------------------
        // STATE MANAGEMENT
        // ------------------------------------------------------------------
        let state = {
            enrollments: [],
            filter: 'all',
            searchTerm: '',
            gradeFilter: '',
            currentEnrollment: null,
            isFirebaseReady: false,
            // Hardcoded key as per user request
            brevoKey: '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',
            emailAction: 'contact' // 'contact', 'approve', 'reject'
        };

        let database;
        let quill;

        // ------------------------------------------------------------------
        // INITIALIZATION
        // ------------------------------------------------------------------
        function initApp() {
            // Restore Key if available
            const keyInput = document.getElementById('brevo-api-key');
            if(keyInput) keyInput.value = state.brevoKey;
            
            const senderInput = document.getElementById('email-from');
            if(senderInput) senderInput.value = config.email.senderEmail;

            // Initialize Quill Editor
            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'Compose email...'
            });

            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(config.firebase);
                    database = firebase.database();
                    state.isFirebaseReady = true;
                    console.log("Firebase initialized.");
                    loadEnrollments();
                } else {
                    throw new Error("Firebase SDK not loaded");
                }
            } catch (error) {
                console.warn("Firebase Init Failed (Running in Demo Mode):", error);
                loadDemoData();
            }
        }

        // ------------------------------------------------------------------
        // DATA OPERATIONS
        // ------------------------------------------------------------------
        async function loadEnrollments() {
            if (!state.isFirebaseReady) return;

            setLoading(true);
            try {
                const snapshot = await database.ref('enrollments').once('value');
                const data = snapshot.val();
                
                if (data) {
                    state.enrollments = Object.keys(data).map(key => {
                        let enrollment = { id: key, ...data[key] };
                        // Ensure status is array for multi-tag support
                        if (typeof enrollment.status === 'string') {
                            enrollment.status = [enrollment.status]; 
                        } else if (!enrollment.status) {
                            enrollment.status = ['pending'];
                        }
                        return enrollment;
                    });
                } else {
                    state.enrollments = [];
                }
                
                render();
            } catch (error) {
                console.error("Load Error:", error);
                showNotification("Failed to load data from server.", "error");
            } finally {
                setLoading(false);
            }
        }

        function loadDemoData() {
            setLoading(true);
            setTimeout(() => {
                state.enrollments = [
                    {
                        id: 'demo1',
                        student_name: 'Maria Santos',
                        parent_name: 'Juan Santos',
                        email: 'juan.santos@example.com',
                        phone: '(555) 123-4567',
                        grade: 'kindergarten',
                        message: 'Excited for the new year!',
                        control_number: '2024-001',
                        queue_number: 1,
                        enrollment_date: new Date(Date.now() - 86400000).toISOString(),
                        status: ['pending']
                    },
                    {
                        id: 'demo2',
                        student_name: 'Carlos Rodriguez',
                        parent_name: 'Ana Rodriguez',
                        email: 'ana.r@example.com',
                        phone: '(555) 987-6543',
                        grade: '1st',
                        message: '',
                        control_number: '2024-002',
                        queue_number: 2,
                        enrollment_date: new Date(Date.now() - 172800000).toISOString(),
                        status: ['approved', 'contacted']
                    }
                ];
                setLoading(false);
                render();
                showNotification("Running in Demo Mode", "info");
            }, 800);
        }

        async function updateStatus(id, action) {
            // Find item
            const idx = state.enrollments.findIndex(e => e.id === id);
            if (idx === -1) return;
            const item = state.enrollments[idx];
            
            // Logic for multiple tags
            let currentTags = new Set(Array.isArray(item.status) ? item.status : [item.status]);

            if (action === 'approve') {
                currentTags.delete('pending');
                currentTags.delete('rejected');
                currentTags.add('approved');
            } else if (action === 'reject') {
                currentTags.delete('pending');
                currentTags.delete('approved');
                currentTags.add('rejected');
            } else if (action === 'contact') {
                currentTags.add('contacted');
            }

            const newTags = Array.from(currentTags);

            if (!state.isFirebaseReady) {
                state.enrollments[idx].status = newTags;
                render();
                showNotification(`Status updated (Demo)`, 'success');
                return;
            }

            try {
                await database.ref(`enrollments/${id}/status`).set(newTags);
                // Optimistic Update
                state.enrollments[idx].status = newTags;
                render();
                showNotification(`Status updated successfully`, 'success');
            } catch (error) {
                console.error("Update Error:", error);
                showNotification("Failed to update status.", "error");
            }
        }

        // ------------------------------------------------------------------
        // EMAIL LOGIC (BREVO)
        // ------------------------------------------------------------------
        function openEmailModal(enrollment, action = 'contact') {
            if (!enrollment) return;
            state.currentEnrollment = enrollment;
            state.emailAction = action;

            const modal = document.getElementById('email-modal');
            const backdrop = document.getElementById('email-backdrop');
            const panel = document.getElementById('email-panel');

            // Set UI elements based on action
            const actionBadge = document.getElementById('email-action-badge');
            const sendBtnText = document.getElementById('email-send-text');
            const subjectInput = document.getElementById('email-subject');
            const markOnlyBtn = document.getElementById('email-mark-only');

            // Default values
            document.getElementById('email-to').value = enrollment.email || '';
            document.getElementById('email-name').value = enrollment.parent_name || '';

            let template = '';
            let subject = '';

            if (action === 'approve') {
                actionBadge.textContent = 'Approve Enrollment';
                actionBadge.className = 'uppercase text-emerald-700 font-bold';
                sendBtnText.textContent = 'Send Approval Email';
                markOnlyBtn.textContent = 'Approve (No Email)';
                subject = `Enrollment Approved: ${enrollment.student_name}`;
                template = `
                    <p>Dear <strong>${enrollment.parent_name}</strong>,</p>
                    <br>
                    <p>We are pleased to inform you that the application for <strong>${enrollment.student_name}</strong> (Grade: ${enrollment.grade}) has been <strong style="color: green;">APPROVED</strong>.</p>
                    <p><strong>Control Number:</strong> ${enrollment.control_number || 'N/A'}</p>
                    <p>Please visit the Registrar's Office by [Date] to complete the final enrollment steps and submit any remaining physical documents.</p>
                    <p>Welcome to the Dr. Alfredo Pio De Roda Elementary School family!</p>
                    <br>
                    <p>Sincerely,</p>
                    <p>Admissions Office</p>
                `;
            } else if (action === 'reject') {
                actionBadge.textContent = 'Reject Application';
                actionBadge.className = 'uppercase text-rose-700 font-bold';
                sendBtnText.textContent = 'Send Rejection Email';
                markOnlyBtn.textContent = 'Reject (No Email)';
                subject = `Update on Enrollment Application for ${enrollment.student_name}`;
                template = `
                    <p>Dear <strong>${enrollment.parent_name}</strong>,</p>
                    <br>
                    <p>Thank you for giving us the opportunity to review your application for <strong>${enrollment.student_name}</strong>.</p>
                    <p>After careful consideration, we regret to inform you that we are unable to offer admission at this time due to [Reason, e.g., limited capacity or incomplete requirements].</p>
                    <p>We wish ${enrollment.student_name} the very best in their future academic endeavors.</p>
                    <br>
                    <p>Sincerely,</p>
                    <p>Admissions Office</p>
                `;
            } else {
                // Default: Contact (Missing Docs)
                actionBadge.textContent = 'Contact Parent';
                actionBadge.className = 'uppercase text-blue-700 font-bold';
                sendBtnText.textContent = 'Send Email & Mark Contacted';
                markOnlyBtn.textContent = 'Mark Contacted (No Email)';
                subject = `Action Required: Enrollment Application for ${enrollment.student_name}`;
                template = `
                    <p>Dear <strong>${enrollment.parent_name}</strong>,</p>
                    <br>
                    <p>We have reviewed your submission for <strong>${enrollment.student_name}</strong> (Control #: ${enrollment.control_number || 'N/A'}).</p>
                    <p>To proceed with enrollment, please provide the following missing documents:</p>
                    <ul>
                        <li>PSA Birth Certificate</li>
                        <li>Report Card (Form 138)</li>
                        <li>Certificate of Good Moral Character</li>
                        <li>2x2 ID Picture</li>
                        <li>Other: ______________________</li>
                    </ul>
                    <p>Please reply to this email or visit the registrar's office to submit these items.</p>
                    <br>
                    <p>Sincerely,</p>
                    <p>Admissions Office</p>
                `;
            }

            subjectInput.value = subject;
            if (quill) {
                quill.clipboard.dangerouslyPasteHTML(template);
            }

            // Show Modal
            modal.classList.remove('hidden');
            void modal.offsetWidth;
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
            panel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
        }

        function closeEmailModal() {
            const modal = document.getElementById('email-modal');
            const backdrop = document.getElementById('email-backdrop');
            const panel = document.getElementById('email-panel');

            backdrop.classList.add('opacity-0');
            panel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            panel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        async function sendEmail() {
            const apiKey = document.getElementById('brevo-api-key').value;
            const fromEmail = document.getElementById('email-from').value;
            const toEmail = document.getElementById('email-to').value;
            const toName = document.getElementById('email-name').value;
            const subject = document.getElementById('email-subject').value;
            
            const editorContent = quill.root.innerHTML;

            // Updated Email Template with GitHub Raw Image
            const finalHtml = `
            <!DOCTYPE html>
            <html>
            <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { font-family: 'Inter', Helvetica, Arial, sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; color: #111827; }
                .email-wrapper { width: 100%; background-color: #f3f4f6; padding: 40px 0; }
                .email-container { max-width: 600px; margin: 0 auto; background-color: #ffffff; overflow: hidden; font-size: 16px; line-height: 1.6; }
                .header-text { font-size: 14px; color: #111827; font-weight: 600; }
                .header-date { font-size: 14px; color: #6b7280; margin-top: 4px; font-weight: 400; }
                .logo-container { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
                .content { padding: 20px 40px; }
                .greeting { font-size: 24px; font-weight: 800; margin-bottom: 20px; letter-spacing: -0.5px; }
                .text-body { margin-bottom: 30px; color: #374151; }
                .btn-container { padding: 0 40px 40px; }
                .btn { display: inline-block; background-color: #111827; color: #ffffff; padding: 16px 32px; text-decoration: none; font-weight: 700; font-size: 12px; letter-spacing: 1px; border-radius: 9999px; text-transform: uppercase; }
                .footer { background-color: #1f2937; padding: 60px 40px; text-align: center; color: #9ca3af; }
                .footer-title { color: #ffffff; font-size: 16px; font-weight: 700; margin-bottom: 20px; }
                .footer-text { font-size: 12px; line-height: 1.6; margin-bottom: 20px; }
                .footer-links a { color: #9ca3af; text-decoration: none; margin: 0 8px; font-size: 12px; font-weight: 600; }
            </style>
            </head>
            <body>
                <div class="email-wrapper">
                    <div class="email-container">
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" style="padding: 40px 40px 20px;">
                            <tr>
                                <td align="left" valign="top">
                                    <div class="header-text">Application Status Update</div>
                                    <div class="header-date">${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                                </td>
                                <td align="right" valign="top">
                                    <div class="logo-container">
                                        <!-- Updated Logo from GitHub in Email -->
                                        <img src="https://raw.githubusercontent.com/Landing749/Dr.Alfredo-Pio-De-Roda/main/school-logo.png" alt="Logo" style="max-width: 100%; max-height: 100%;">
                                    </div>
                                </td>
                            </tr>
                        </table>
                        <div class="content">
                            <div class="greeting">Hello ${toName.split(' ')[0]},</div>
                            <div class="text-body">
                                ${editorContent}
                            </div>
                        </div>
                        <div class="btn-container">
                            <a href="https://dapres.dpdns.org/" class="btn" style="background-color: #000; color: #fff; padding: 15px 30px; text-decoration: none; border-radius: 30px; font-weight: bold; font-size: 12px;">VISIT REGISTRAR</a>
                        </div>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f3f4f6; margin: 0 40px 40px; width: calc(100% - 80px);">
                            <tr>
                                <td style="padding: 30px;">
                                    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px;">STUDENT INFO</div>
                                    <div style="font-size: 14px; margin-bottom: 5px;">${state.currentEnrollment?.student_name}</div>
                                    <div style="font-size: 14px; color: #6b7280;">Grade: ${state.currentEnrollment?.grade}</div>
                                </td>
                            </tr>
                        </table>
                        <div class="footer" style="background-color: #1f2937; padding: 60px 40px; text-align: center; color: #9ca3af;">
                            <div class="footer-title" style="color: #ffffff; font-size: 16px; font-weight: 700; margin-bottom: 20px;">Questions? Contact Us.</div>
                            <div class="footer-text" style="font-size: 12px; line-height: 1.6; margin-bottom: 20px;">
                                Dr. Alfredo Pio De Roda Elementary School
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
            `;

            if (!apiKey) {
                showNotification("Missing Brevo API Key.", "error");
                return;
            }

            const payload = {
                sender: {
                    name: config.email.senderName,
                    email: fromEmail
                },
                to: [{
                    email: toEmail,
                    name: toName
                }],
                subject: subject,
                htmlContent: finalHtml
            };

            const btn = document.getElementById('email-send');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div> Sending...`;
            btn.disabled = true;

            try {
                const response = await fetch('https://api.brevo.com/v3/smtp/email', {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'api-key': apiKey,
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showNotification("Email sent successfully!", "success");
                    if(state.currentEnrollment) {
                        updateStatus(state.currentEnrollment.id, state.emailAction); // Pass ACTION, not resolved status
                    }
                    closeEmailModal();
                } else {
                    const errData = await response.json();
                    console.error("Brevo Error:", errData);
                    
                    if(errData.code === 'invalid_parameter') {
                         showNotification("Error: Sender email not verified in Brevo.", "error");
                    } else {
                         // API Failure (e.g., 401, 400)
                        showNotification(`API Error ${response.status}: Email could not be sent.`, "error");
                    }
                    
                    // Keep modal open so the user can debug the key/sender email
                }
            } catch (error) {
                console.error("Network Error:", error);
                 // Network/CORS Failure
                showNotification("Network Error: Could not connect to Brevo API. Check Console.", "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ------------------------------------------------------------------
        // RENDERING & UI LOGIC
        // ------------------------------------------------------------------
        function render() {
            updateStats();
            renderTable();
        }

        function updateStats() {
            const total = state.enrollments.length;
            const pending = state.enrollments.filter(e => e.status.includes('pending')).length;
            const approved = state.enrollments.filter(e => e.status.includes('approved')).length;
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const week = state.enrollments.filter(e => new Date(e.enrollment_date) >= oneWeekAgo).length;

            document.getElementById('total-count').textContent = total;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('approved-count').textContent = approved;
            document.getElementById('week-count').textContent = week;
        }

        function getFilteredData() {
            return state.enrollments.filter(item => {
                const tags = item.status || [];
                const matchesStatus = state.filter === 'all' || tags.includes(state.filter);
                const matchesGrade = state.gradeFilter === '' || item.grade === state.gradeFilter;
                const searchLower = state.searchTerm.toLowerCase();
                const matchesSearch = !searchLower || 
                    item.student_name.toLowerCase().includes(searchLower) ||
                    item.parent_name.toLowerCase().includes(searchLower) ||
                    item.email.toLowerCase().includes(searchLower) ||
                    (item.control_number && item.control_number.toLowerCase().includes(searchLower));
                
                return matchesStatus && matchesGrade && matchesSearch;
            }).sort((a, b) => new Date(b.enrollment_date) - new Date(a.enrollment_date));
        }

        function renderTable() {
            const tbody = document.getElementById('enrollments-tbody');
            const data = getFilteredData();
            
            if (data.length === 0) {
                document.getElementById('enrollments-container').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('enrollments-container').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');

            tbody.innerHTML = data.map(item => {
                const tags = Array.isArray(item.status) ? item.status : [item.status];
                
                const badgesHtml = tags.map(tag => {
                    const styles = {
                        pending: 'bg-amber-100 text-amber-800',
                        approved: 'bg-emerald-100 text-emerald-800',
                        rejected: 'bg-rose-100 text-rose-800',
                        contacted: 'bg-blue-100 text-blue-800'
                    };
                    const css = styles[tag] || 'bg-slate-100 text-slate-800';
                    return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wide mr-1 ${css}">${tag}</span>`;
                }).join('');

                return `
                <tr class="hover:bg-slate-50 transition-colors duration-150">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-slate-900">${item.student_name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-slate-900">${item.parent_name}</div>
                        <div class="text-xs text-slate-500">${item.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800 capitalize">
                            ${item.grade}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="font-mono text-xs bg-slate-100 px-2 py-1 rounded border border-slate-200 text-slate-600">
                            ${item.control_number || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-bold text-blue-600">#${item.queue_number}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                        ${formatDate(item.enrollment_date)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${badgesHtml}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex gap-2">
                            <button onclick="openModal('${item.id}')" class="text-slate-600 hover:text-blue-600 bg-white border border-slate-300 hover:border-blue-400 rounded px-3 py-1.5 transition-all text-xs shadow-sm">View</button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function openModal(id) {
            const item = state.enrollments.find(e => e.id === id);
            if (!item) return;
            state.currentEnrollment = item;
            
            const modal = document.getElementById('detail-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');
            const content = document.getElementById('modal-content');

            // Determine border color based on primary status
            const tags = Array.isArray(item.status) ? item.status : [item.status];
            let statusColor = 'border-slate-200 bg-slate-50 text-slate-800';
            if(tags.includes('approved')) statusColor = 'border-emerald-200 bg-emerald-50 text-emerald-800';
            else if(tags.includes('rejected')) statusColor = 'border-rose-200 bg-rose-50 text-rose-800';
            else if(tags.includes('pending')) statusColor = 'border-amber-200 bg-amber-50 text-amber-800';

            const badgesHtml = tags.map(tag => `<span class="uppercase font-bold mr-2">${tag}</span>`).join('/');

            content.innerHTML = `
                <div class="flex items-center justify-between p-4 rounded-lg border ${statusColor}">
                    <div>
                        <p class="text-xs font-bold uppercase opacity-70">Current Status</p>
                        <p class="text-lg font-bold">${badgesHtml}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold uppercase opacity-70">Control Number</p>
                        <p class="text-lg font-mono font-bold">${item.control_number || 'N/A'}</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-1">Student Information</h4>
                        <div class="text-sm space-y-2">
                            <div class="flex justify-between"><span class="text-slate-500">Name:</span> <span class="font-medium text-slate-900">${item.student_name}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Grade:</span> <span class="font-medium text-slate-900 capitalize">${item.grade}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Queue #:</span> <span class="font-medium text-blue-600">#${item.queue_number}</span></div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-1">Guardian Information</h4>
                        <div class="text-sm space-y-2">
                            <div class="flex justify-between"><span class="text-slate-500">Name:</span> <span class="font-medium text-slate-900">${item.parent_name}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Email:</span> <span class="font-medium text-slate-900 truncate max-w-[150px]" title="${item.email}">${item.email}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Phone:</span> <span class="font-medium text-slate-900">${item.phone}</span></div>
                        </div>
                    </div>
                </div>

                ${item.message ? `
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-1 mb-2">Message</h4>
                        <div class="bg-slate-50 p-3 rounded-md border border-slate-100 text-slate-600 text-sm italic">
                            "${item.message}"
                        </div>
                    </div>
                ` : ''}
                
                <div class="text-xs text-slate-400 text-center pt-2">
                    Application received on ${formatDate(item.enrollment_date, true)}
                </div>
            `;

            modal.classList.remove('hidden');
            void modal.offsetWidth;
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
            panel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');

            backdrop.classList.add('opacity-0');
            panel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            panel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function setLoading(isLoading) {
            const loader = document.getElementById('loading-state');
            if (isLoading) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        function formatDate(isoString, full = false) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const opts = full 
                ? { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }
                : { month: 'short', day: 'numeric', year: 'numeric' };
            return date.toLocaleDateString('en-US', opts);
        }

        function showNotification(msg, type = 'info') {
            const div = document.createElement('div');
            const colors = {
                success: 'bg-emerald-600',
                error: 'bg-rose-600',
                info: 'bg-slate-800'
            };
            
            div.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-10 opacity-0 z-50 flex items-center gap-2 text-sm font-medium`;
            div.innerHTML = `<span>${msg}</span>`;
            
            document.body.appendChild(div);
            
            requestAnimationFrame(() => {
                div.classList.remove('translate-y-10', 'opacity-0');
            });

            setTimeout(() => {
                div.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        function exportToCSV() {
            if (state.enrollments.length === 0) {
                showNotification("No data to export", "error");
                return;
            }
            
            const headers = ['ID', 'Student Name', 'Parent Name', 'Email', 'Phone', 'Grade', 'Control #', 'Queue #', 'Date', 'Status', 'Message'];
            const rows = state.enrollments.map(e => [
                e.id,
                `"${e.student_name}"`,
                `"${e.parent_name}"`,
                e.email,
                e.phone,
                e.grade,
                e.control_number,
                e.queue_number,
                formatDate(e.enrollment_date, true),
                e.status.join('/'),
                `"${(e.message || '').replace(/"/g, '""')}"`
            ]);

            const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `enrollments_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification("Export downloaded!", "success");
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();

            const tabs = document.querySelectorAll('#filter-tabs button');
            tabs.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    tabs.forEach(t => {
                        t.className = "px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-white text-slate-600 border border-slate-200 hover:bg-slate-50";
                    });
                    e.target.className = "px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-slate-900 text-white shadow-sm";
                    state.filter = e.target.dataset.status;
                    render();
                });
            });

            document.getElementById('search-input')?.addEventListener('input', (e) => {
                state.searchTerm = e.target.value;
                render();
            });

            document.getElementById('grade-filter')?.addEventListener('change', (e) => {
                state.gradeFilter = e.target.value;
                render();
            });

            document.getElementById('refresh-btn')?.addEventListener('click', () => {
                loadEnrollments();
            });

            document.getElementById('export-btn')?.addEventListener('click', exportToCSV);

            document.getElementById('close-detail-modal')?.addEventListener('click', closeModal);
            document.getElementById('detail-modal')?.addEventListener('click', (e) => {
                if(e.target.id === 'modal-backdrop' || e.target.id === 'detail-modal') closeModal();
            });

            // Email Modal Listeners
            document.getElementById('close-email-modal')?.addEventListener('click', closeEmailModal);
            document.getElementById('email-cancel')?.addEventListener('click', closeEmailModal);
            
            // Send Email (and update status)
            document.getElementById('email-send')?.addEventListener('click', sendEmail);
            
            // Mark without Email
            document.getElementById('email-mark-only')?.addEventListener('click', () => {
                if(state.currentEnrollment) {
                    updateStatus(state.currentEnrollment.id, state.emailAction);
                    closeEmailModal();
                }
            });

            document.getElementById('email-modal')?.addEventListener('click', (e) => {
                if(e.target.id === 'email-backdrop' || e.target.id === 'email-modal') closeEmailModal();
            });

            // Workflow Actions
            // Approve -> Open Email with Approve Template
            document.getElementById('modal-approve')?.addEventListener('click', () => {
                if(state.currentEnrollment) {
                    closeModal();
                    setTimeout(() => {
                        openEmailModal(state.currentEnrollment, 'approve');
                    }, 300);
                }
            });
            
            // Contact -> Open Email with Contact Template
            document.getElementById('modal-contact')?.addEventListener('click', () => {
                if(state.currentEnrollment) {
                    closeModal();
                    setTimeout(() => {
                        openEmailModal(state.currentEnrollment, 'contact');
                    }, 300);
                }
            });

            // Reject -> Open Email with Reject Template
            document.getElementById('modal-reject')?.addEventListener('click', () => {
                if(state.currentEnrollment) {
                    closeModal();
                    setTimeout(() => {
                        openEmailModal(state.currentEnrollment, 'reject');
                    }, 300);
                }
            });
        });
    </script>
</body>
</html>
