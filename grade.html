<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://dapres.dpdns.org/analytics.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Alfredo Pio De Roda Elementary - Grading System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs (Realtime Database) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Configuration (HARDCODED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAYpXaL6oNhuX3LWAinx7LmhrAozfVzCvk",
            authDomain: "dr-de-roda-lr-portal.firebaseapp.com",
            databaseURL: "https://dr-de-roda-lr-portal-default-rtdb.firebaseio.com",
            projectId: "dr-de-roda-lr-portal",
            storageBucket: "dr-de-roda-lr-portal.firebasestorage.app",
            messagingSenderId: "1074205661200",
            appId: "1:1074205661200:web:f42d20c85f8600728cd295",
            measurementId: "G-MJF7Z2DYHS"
        };
        
        const app = initializeApp(firebaseConfig);
        // Initialize Realtime Database
        const db = getDatabase(app);
        
        // Get raw App ID and sanitize it for RTDB (remove . # $ [ ])
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'dr-roda-default';
        const appId = rawAppId.replace(/[.#$[\]]/g, '_');
        
        // App State
        let students = [];
        let subjects = [];
        let activities = [];
        let scores = [];
        let behaviorLogs = [];
        let currentView = 'dashboard';
        let charts = {};
        let studentCharts = {}; 
        
        // Filters
        let filterGradeLevel = 'all';

        // DOM Elements
        const views = {
            dashboard: document.getElementById('view-dashboard'),
            gradebook: document.getElementById('view-gradebook'),
            students: document.getElementById('view-students'),
            subjects: document.getElementById('view-subjects'),
            reports: document.getElementById('view-reports')
        };

        // --- Data Listeners (RTDB) ---
        function initDataListeners() {
            // Helper to get reference path
            const getRef = (path) => ref(db, `artifacts/${appId}/public/data/${path}`);

            // Helper to process snapshot into array
            const processSnap = (snap, targetVar, callback) => {
                const data = snap.val();
                targetVar.length = 0; // Clear in place
                if (data) {
                    Object.entries(data).forEach(([key, value]) => {
                        targetVar.push({ id: key, ...value });
                    });
                }
                if(callback) callback();
                refreshUI();
            };

            onValue(getRef('students'), (snap) => {
                const data = snap.val();
                students = data ? Object.entries(data).map(([k, v]) => ({id: k, ...v})) : [];
                students.sort((a, b) => {
                    const nameA = `${a.lastName}, ${a.firstName} ${a.middleName || ''}`.toLowerCase();
                    const nameB = `${b.lastName}, ${b.firstName} ${b.middleName || ''}`.toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                refreshUI();
            });

            onValue(getRef('subjects'), (snap) => processSnap(snap, subjects));
            onValue(getRef('activities'), (snap) => processSnap(snap, activities));
            onValue(getRef('scores'), (snap) => processSnap(snap, scores));
            onValue(getRef('behaviorLogs'), (snap) => processSnap(snap, behaviorLogs));
        }

        initDataListeners();

        // --- Core Logic ---

        function getFullName(s) {
            if(s.name) return s.name; 
            return `${s.lastName}, ${s.firstName} ${s.middleName ? s.middleName.charAt(0) + '.' : ''}`;
        }

        function calculateGrade(studentId, subjectId) {
            const sub = subjects.find(s => s.id === subjectId);
            if (!sub) return { final: 0, details: {} };

            const subActivities = activities.filter(a => a.subjectId === subjectId);
            const components = {
                written: { scores: 0, max: 0, weight: sub.components.written },
                performance: { scores: 0, max: 0, weight: sub.components.performance },
                exam: { scores: 0, max: 0, weight: sub.components.exam }
            };

            subActivities.forEach(act => {
                const scoreEntry = scores.find(s => s.studentId === studentId && s.activityId === act.id);
                const scoreVal = scoreEntry ? parseFloat(scoreEntry.score) : 0;
                if (components[act.componentType]) {
                    components[act.componentType].scores += scoreVal;
                    components[act.componentType].max += parseFloat(act.maxScore);
                }
            });

            let finalGrade = 0;
            const details = {};

            for (const [key, data] of Object.entries(components)) {
                let percentage = 0;
                if (data.max > 0) percentage = (data.scores / data.max) * 100;
                const weightedScore = percentage * (data.weight / 100);
                finalGrade += weightedScore;
                details[key] = { percentage: percentage.toFixed(2), weighted: weightedScore.toFixed(2) };
            }
            return { final: finalGrade.toFixed(2), details };
        }

        function calculateOverallAverage(studentId) {
            if (subjects.length === 0) return 0;
            let total = 0;
            let count = 0;
            subjects.forEach(sub => {
                total += parseFloat(calculateGrade(studentId, sub.id).final);
                count++;
            });
            return count === 0 ? 0 : (total / count).toFixed(2);
        }

        function getStudentStatus(studentId) {
            const avg = calculateOverallAverage(studentId);
            const logs = behaviorLogs.filter(b => b.studentId === studentId);
            const incidents = logs.length;
            
            let status = 'Good';
            let color = 'text-emerald-400 bg-emerald-400/10 border-emerald-400/20';

            if (avg < 75 || incidents > 2) {
                status = 'At Risk';
                color = 'text-rose-400 bg-rose-400/10 border-rose-400/20';
            } else if (avg < 80) {
                status = 'Monitor';
                color = 'text-amber-400 bg-amber-400/10 border-amber-400/20';
            }
            return { status, color, avg, incidents };
        }

        function getGradeLevels() {
            const grades = new Set(students.map(s => s.grade).filter(g => g));
            return Array.from(grades).sort();
        }

        // --- UI Rendering ---

        function refreshUI() {
            if (currentView === 'dashboard') renderDashboard();
            else if (currentView === 'gradebook') renderGradebook();
            else if (currentView === 'students') renderStudents();
            else if (currentView === 'subjects') renderSubjects();
            else if (currentView === 'reports') renderReports();
        }

        window.toggleMobileMenu = () => {
            const aside = document.querySelector('aside');
            const isHidden = aside.classList.contains('hidden');
            if (isHidden) {
                aside.classList.remove('hidden');
                aside.classList.add('fixed', 'top-16', 'left-0', 'w-full', 'h-[calc(100%-4rem)]', 'z-40', 'border-t', 'border-slate-800');
            } else {
                aside.classList.add('hidden');
                aside.classList.remove('fixed', 'top-16', 'left-0', 'w-full', 'h-[calc(100%-4rem)]', 'z-40', 'border-t', 'border-slate-800');
            }
        };

        window.switchView = (viewName, subjectId = null) => {
            currentView = viewName;
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.view === viewName) {
                    el.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-900/50');
                    el.classList.remove('text-slate-400', 'hover:text-white');
                } else {
                    el.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-900/50');
                    el.classList.add('text-slate-400', 'hover:text-white');
                }
            });

            if (window.innerWidth < 768) {
                const aside = document.querySelector('aside');
                if(!aside.classList.contains('hidden')) toggleMobileMenu();
            }

            // If subjectId is passed (from Subject view click), set it in gradebook
            if (viewName === 'gradebook' && subjectId) {
                selectedSubjectId = subjectId;
            }

            refreshUI();
        };

        window.setGradeFilter = (val) => {
            filterGradeLevel = val;
            refreshUI();
        };

        // --- Dashboard ---
        function renderDashboard() {
            const totalStudents = students.length;
            const atRisk = students.filter(s => getStudentStatus(s.id).status === 'At Risk').length;
            
            document.getElementById('dash-total-students').innerText = totalStudents;
            document.getElementById('dash-subjects').innerText = subjects.length;
            document.getElementById('dash-at-risk').innerText = atRisk;
            
            // Show helpful message if empty
            if (totalStudents === 0 && subjects.length === 0) {
                 document.getElementById('dash-empty-state').classList.remove('hidden');
            } else {
                 document.getElementById('dash-empty-state').classList.add('hidden');
            }

            renderCharts();
        }

        function renderCharts() {
            if(document.hidden) return;

            const ctxBar = document.getElementById('performanceChart');
            if(ctxBar) {
                let buckets = { '90-100': 0, '80-89': 0, '75-79': 0, 'Below 75': 0 };
                students.forEach(s => {
                    const avg = parseFloat(calculateOverallAverage(s.id));
                    if (avg >= 90) buckets['90-100']++;
                    else if (avg >= 80) buckets['80-89']++;
                    else if (avg >= 75) buckets['75-79']++;
                    else buckets['Below 75']++;
                });

                if (charts.performance) charts.performance.destroy();
                Chart.defaults.color = '#94a3b8';
                Chart.defaults.borderColor = '#334155';
                charts.performance = new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(buckets),
                        datasets: [{
                            label: 'Count',
                            data: Object.values(buckets),
                            backgroundColor: ['#4ade80', '#60a5fa', '#facc15', '#f87171'],
                            borderRadius: 6,
                            barThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { grid: { color: '#1e293b' } }, x: { grid: { display: false } } }
                    }
                });
            }
        }

        // --- Gradebook ---
        let selectedSubjectId = 'all';

        window.renderGradebook = () => {
            const container = document.getElementById('gradebook-container');
            const subjectSelect = document.getElementById('gb-subject-select');
            
            const gradeFilterContainer = document.getElementById('gb-grade-filter');
            const uniqueGrades = getGradeLevels();
            gradeFilterContainer.innerHTML = `<option value="all">All Grades</option>` + uniqueGrades.map(g => `<option value="${g}" ${filterGradeLevel === g ? 'selected' : ''}>Grade ${g}</option>`).join('');
            gradeFilterContainer.value = filterGradeLevel;

            // Rebuild subject select
            subjectSelect.innerHTML = '<option value="all">Summary View</option>' + subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            subjectSelect.value = selectedSubjectId;

            const filteredStudents = filterGradeLevel === 'all' 
                ? students 
                : students.filter(s => s.grade === filterGradeLevel);

            if (selectedSubjectId === 'all') renderSummaryGradebook(container, filteredStudents);
            else renderDetailedGradebook(container, selectedSubjectId, filteredStudents);
        };

        function renderSummaryGradebook(container, filteredStudents) {
            let html = `
                <div class="h-full overflow-auto custom-scrollbar">
                <table class="min-w-full text-sm text-left border-separate border-spacing-0">
                    <thead class="text-xs uppercase bg-slate-800 text-slate-400 sticky top-0 z-20 shadow-md">
                        <tr>
                            <th class="px-6 py-4 font-medium sticky left-0 bg-slate-800 z-30 border-b border-r border-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.3)]">Student Name</th>
                            <th class="px-2 py-4 text-center border-b border-slate-700 sticky top-0 z-20 bg-slate-800">Grade</th>
                            ${subjects.map(s => `<th class="px-6 py-4 text-center border-b border-slate-700 sticky top-0 z-20 bg-slate-800">${s.name}</th>`).join('')}
                            <th class="px-6 py-4 text-center font-bold text-blue-400 border-b border-slate-700 sticky top-0 z-20 bg-slate-800">Overall</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800">
            `;

            filteredStudents.forEach(student => {
                const overall = calculateOverallAverage(student.id);
                const fullName = getFullName(student);
                html += `
                    <tr class="hover:bg-slate-800/50 transition-colors group">
                        <td class="px-6 py-4 font-medium text-slate-200 sticky left-0 bg-slate-900 group-hover:bg-slate-800 transition-colors z-10 border-r border-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.3)]">${fullName}</td>
                        <td class="px-2 py-4 text-center text-slate-500 text-xs">${student.grade || '-'}</td>
                        ${subjects.map(s => {
                            const grade = calculateGrade(student.id, s.id);
                            let colorClass = grade.final < 75 ? 'text-rose-500 font-bold' : 'text-slate-400';
                            return `<td class="px-6 py-4 text-center ${colorClass}">${grade.final}</td>`;
                        }).join('')}
                        <td class="px-6 py-4 text-center font-bold text-blue-400">${overall}</td>
                    </tr>
                `;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function renderDetailedGradebook(container, subjectId, filteredStudents) {
            const subject = subjects.find(s => s.id === subjectId);
            if(!subject) {
                 selectedSubjectId = 'all';
                 renderGradebook();
                 return;
            }
            const subActivities = activities.filter(a => a.subjectId === subjectId).sort((a,b) => new Date(a.date) - new Date(b.date));

            let html = `
                <div class="flex flex-col h-full">
                    <div class="mb-4 shrink-0 flex flex-col md:flex-row justify-between items-center bg-slate-800 p-4 rounded-lg border border-slate-700 gap-4">
                        <div>
                            <h3 class="text-xl font-bold text-white tracking-tight">${subject.name}</h3>
                            <div class="text-xs text-slate-400 mt-1">
                                WW: ${subject.components.written}% | PT: ${subject.components.performance}% | QA: ${subject.components.exam}%
                            </div>
                        </div>
                        <button onclick="openAddActivityModal('${subjectId}')" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg shadow-blue-900/50 transition-all flex items-center text-sm font-medium">
                            <i class="fas fa-plus mr-2"></i> Add Activity
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-auto rounded-lg border border-slate-700 relative custom-scrollbar">
                        <table class="min-w-full divide-y divide-slate-700 border-separate border-spacing-0">
                            <thead class="bg-slate-800 sticky top-0 z-20 shadow-md">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider sticky left-0 top-0 bg-slate-800 z-30 border-r border-b border-slate-700 shadow-[2px_2px_5px_rgba(0,0,0,0.3)]">Student</th>
                                    ${subActivities.map(a => `
                                        <th class="px-2 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider border-r border-b border-slate-700 min-w-[100px] bg-slate-800 sticky top-0 z-20">
                                            <div class="font-bold text-slate-200 truncate w-24 mx-auto" title="${a.title}">${a.title}</div>
                                            <div class="text-[10px] text-slate-500 mt-1 px-1 py-0.5 rounded bg-slate-700 inline-block">${a.componentType.toUpperCase()} / ${a.maxScore}</div>
                                        </th>
                                    `).join('')}
                                    <th class="px-4 py-3 text-center text-xs font-bold text-white uppercase tracking-wider border-b border-slate-700 bg-slate-800 sticky top-0 z-20">Final</th>
                                </tr>
                            </thead>
                            <tbody class="bg-slate-900 divide-y divide-slate-800">
            `;

            filteredStudents.forEach(student => {
                const gradeData = calculateGrade(student.id, subjectId);
                const fullName = getFullName(student);
                
                html += `<tr class="hover:bg-slate-800/50 transition-colors group">
                    <td class="px-4 py-3 whitespace-nowrap font-medium text-slate-200 sticky left-0 bg-slate-900 group-hover:bg-slate-800 transition-colors border-r border-slate-700 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.3)]">${fullName}</td>`;
                
                subActivities.forEach(act => {
                    const scoreEntry = scores.find(s => s.studentId === student.id && s.activityId === act.id);
                    const val = scoreEntry ? scoreEntry.score : '';
                    html += `
                        <td class="p-0 border-r border-slate-800 relative">
                            <input type="number" 
                                class="w-full h-full p-2 text-center bg-transparent text-slate-300 focus:outline-none focus:bg-slate-800 focus:text-white transition-all placeholder-slate-700"
                                value="${val}" 
                                min="0" max="${act.maxScore}"
                                placeholder="-"
                                onchange="updateScore('${student.id}', '${act.id}', this.value)"
                            >
                        </td>`;
                });

                html += `<td class="px-4 py-3 text-center font-bold text-blue-400 bg-blue-900/10">${gradeData.final}</td></tr>`;
            });
            html += `</tbody></table></div></div>`;
            container.innerHTML = html;
        }

        // --- Students View ---
        
        window.toggleStudentCard = (studentId) => {
            const expandedRow = document.getElementById(`expanded-${studentId}`);
            if (expandedRow.classList.contains('hidden')) {
                expandedRow.classList.remove('hidden');
                renderStudentGauge(studentId);
            } else {
                expandedRow.classList.add('hidden');
            }
        };

        function renderStudentGauge(studentId) {
            const canvasId = `gauge-${studentId}`;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            const overall = parseFloat(calculateOverallAverage(studentId));
            if(studentCharts[studentId]) studentCharts[studentId].destroy();
            let color = '#34d399';
            if (overall < 75) color = '#f43f5e';
            else if (overall < 80) color = '#fbbf24';

            studentCharts[studentId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Grade', 'Remaining'],
                    datasets: [{
                        data: [overall, 100 - overall],
                        backgroundColor: [color, '#1e293b'],
                        borderWidth: 0,
                        borderRadius: 5
                    }]
                },
                options: {
                    rotation: -90,
                    circumference: 180,
                    cutout: '75%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { tooltip: { enabled: false }, legend: { display: false } },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }

        window.renderStudents = () => {
            const list = document.getElementById('students-list');
            const gradeFilterSelect = document.getElementById('st-grade-filter');
            
            const uniqueGrades = getGradeLevels();
            gradeFilterSelect.innerHTML = `<option value="all">All Grades</option>` + uniqueGrades.map(g => `<option value="${g}" ${filterGradeLevel === g ? 'selected' : ''}>Grade ${g}</option>`).join('');

            const filtered = filterGradeLevel === 'all' 
                ? students 
                : students.filter(s => s.grade === filterGradeLevel);

            list.innerHTML = filtered.map(s => {
                const status = getStudentStatus(s.id);
                const fullName = getFullName(s);
                const overall = calculateOverallAverage(s.id);
                const logs = behaviorLogs.filter(b => b.studentId === s.id);

                return `
                <div class="bg-slate-800 rounded-xl shadow-md border border-slate-700 overflow-hidden transition-all mb-4">
                    <div class="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-700/50" onclick="toggleStudentCard('${s.id}')">
                        <div class="flex items-center space-x-4">
                            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white font-bold shadow-lg shadow-blue-900/50">
                                ${s.lastName ? s.lastName.charAt(0) : s.name.charAt(0)}
                            </div>
                            <div>
                                <p class="font-bold text-slate-200">${fullName}</p>
                                <p class="text-xs text-slate-500">${s.grade ? 'Grade ' + s.grade + ' - ' : ''} ${s.section}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold border ${status.color}">${status.status}</span>
                            <i class="fas fa-chevron-down text-slate-500"></i>
                        </div>
                    </div>
                    <div id="expanded-${s.id}" class="hidden bg-slate-900/50 border-t border-slate-700 p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center justify-center relative">
                                <h4 class="text-slate-400 text-xs uppercase tracking-wider mb-2">Overall Average</h4>
                                <div class="h-32 w-48 relative">
                                    <canvas id="gauge-${s.id}"></canvas>
                                    <div class="absolute inset-0 flex items-end justify-center pb-2 pointer-events-none">
                                        <span class="text-3xl font-bold text-white">${overall}%</span>
                                    </div>
                                </div>
                                <div class="w-full mt-2 text-center">
                                    <span class="text-xs text-slate-500">LRN: ${s.lrn || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 md:col-span-2">
                                <h4 class="text-slate-400 text-xs uppercase tracking-wider mb-3">Subject Breakdown</h4>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                    ${subjects.map(sub => {
                                        const g = calculateGrade(s.id, sub.id);
                                        const color = g.final < 75 ? 'text-rose-400' : 'text-emerald-400';
                                        return `
                                            <div class="bg-slate-900 p-2 rounded border border-slate-700">
                                                <div class="text-xs text-slate-500 truncate" title="${sub.name}">${sub.name}</div>
                                                <div class="font-bold ${color}">${g.final}%</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                             <div class="md:col-span-3 bg-slate-800 p-4 rounded-xl border border-slate-700">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-slate-400 text-xs uppercase tracking-wider">Behavior Incidents</h4>
                                    <button onclick="addBehaviorLog('${s.id}')" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded transition-colors">+ Log Incident</button>
                                </div>
                                <div class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                    ${logs.length === 0 
                                        ? '<div class="text-slate-500 text-sm italic">No incidents recorded.</div>' 
                                        : logs.map(l => `
                                            <div class="flex justify-between items-start bg-slate-900 p-2 rounded border-l-2 border-rose-500 text-sm">
                                                <div>
                                                    <span class="font-bold text-rose-400 block">${l.type}</span>
                                                    <span class="text-slate-400 text-xs">${l.notes}</span>
                                                </div>
                                                <span class="text-slate-600 text-xs">${l.date}</span>
                                            </div>
                                        `).join('')}
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        };
        
        window.renderSubjects = () => {
            const list = document.getElementById('subjects-list');
            list.innerHTML = subjects.map(s => `
                <div onclick="switchView('gradebook', '${s.id}')" class="cursor-pointer p-5 bg-slate-900 rounded-lg shadow border border-slate-800 animate-fade-in relative group hover:border-blue-500/50 transition-colors">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-lg text-slate-200 group-hover:text-blue-400 transition-colors">${s.name}</h3>
                        <i class="fas fa-chevron-right text-slate-700 group-hover:text-blue-500 transition-colors"></i>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm text-slate-400 bg-slate-950/50 p-3 rounded-lg border border-slate-800">
                        <div class="text-center">
                            <div class="font-bold text-blue-400 text-lg">${s.components.written}%</div>
                            <div class="text-[10px] uppercase tracking-wider">Written</div>
                        </div>
                        <div class="text-center border-l border-slate-800">
                            <div class="font-bold text-emerald-400 text-lg">${s.components.performance}%</div>
                            <div class="text-[10px] uppercase tracking-wider">Perf.</div>
                        </div>
                        <div class="text-center border-l border-slate-800">
                            <div class="font-bold text-purple-400 text-lg">${s.components.exam}%</div>
                            <div class="text-[10px] uppercase tracking-wider">Exam</div>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        window.renderReports = () => {
            const container = document.getElementById('report-preview');
            const atRisk = students.filter(s => getStudentStatus(s.id).status === 'At Risk');

            let html = `
                <div class="bg-white text-black p-10 shadow-xl max-w-4xl mx-auto print:shadow-none print:w-full" id="printable-report">
                    <div class="text-center mb-10 border-b-2 border-black pb-6">
                        <h1 class="text-3xl font-bold uppercase tracking-wide">Dr. Alfredo Pio De Roda Elementary School</h1>
                        <p class="text-gray-600 mt-2">Official Student Performance Report</p>
                        <p class="text-sm text-gray-400">Generated: ${new Date().toLocaleDateString()}</p>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-lg font-bold mb-4 uppercase text-red-700 border-b border-gray-300 pb-2">At-Risk Students (Intervention Needed)</h2>
                        <table class="w-full text-left text-sm border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 border-b font-bold">Student Name</th>
                                    <th class="p-3 border-b font-bold">LRN</th>
                                    <th class="p-3 border-b font-bold">Section</th>
                                    <th class="p-3 border-b font-bold">Avg</th>
                                    <th class="p-3 border-b font-bold">Incidents</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${atRisk.length === 0 ? '<tr><td colspan="5" class="p-4 text-center text-gray-500 italic">No students flagged at risk.</td></tr>' : 
                                atRisk.map(s => {
                                    const stat = getStudentStatus(s.id);
                                    const name = getFullName(s);
                                    return `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-3">${name}</td>
                                            <td class="p-3 font-mono text-xs">${s.lrn || '-'}</td>
                                            <td class="p-3">${s.section}</td>
                                            <td class="p-3 font-bold text-red-600">${stat.avg}</td>
                                            <td class="p-3">${stat.incidents}</td>
                                        </tr>
                                    `;
                                }).join('')
                                }
                            </tbody>
                        </table>
                    </div>

                    <div>
                        <h2 class="text-lg font-bold mb-4 uppercase text-blue-800 border-b border-gray-300 pb-2">Subject Performance Summary</h2>
                        <div class="grid grid-cols-2 gap-4">
                            ${subjects.map(sub => {
                                let total = 0, count = 0;
                                students.forEach(s => {
                                    total += parseFloat(calculateGrade(s.id, sub.id).final);
                                    count++;
                                });
                                const avg = count ? (total/count).toFixed(2) : 0;
                                return `
                                    <div class="border p-4 rounded bg-gray-50">
                                        <div class="font-bold text-lg">${sub.name}</div>
                                        <div class="text-sm text-gray-500">Class Average</div>
                                        <div class="text-2xl font-bold text-blue-600">${avg}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                <div class="mt-6 text-center no-print">
                    <button onclick="window.print()" class="bg-blue-600 text-white px-8 py-3 rounded-full shadow-lg shadow-blue-600/50 hover:bg-blue-500 transition-all font-bold">
                        <i class="fas fa-print mr-2"></i> Print Official Report
                    </button>
                </div>
            `;
            container.innerHTML = html;
        };

        // --- Presets ---
        window.applyDepEdPreset = () => {
             const preset = document.getElementById('deped-preset').value;
             if(!preset) return;
             
             // Weights: Written / Performance / Exam
             const weights = {
                 'lang': [30, 50, 20], // Languages / AP / EsP
                 'math': [40, 40, 20], // Math / Science
                 'mapeh': [20, 60, 20] // MAPEH / EPP / TLE
             };
             
             if(weights[preset]) {
                 document.getElementById('new-sub-written').value = weights[preset][0];
                 document.getElementById('new-sub-perf').value = weights[preset][1];
                 document.getElementById('new-sub-exam').value = weights[preset][2];
             }
        };

        // --- Database Actions ---

        window.addStudent = async (e) => {
            e.preventDefault();
            const lastName = document.getElementById('st-lastname').value;
            const firstName = document.getElementById('st-firstname').value;
            const middleName = document.getElementById('st-middlename').value;
            const lrn = document.getElementById('st-lrn').value;
            const dob = document.getElementById('st-dob').value;
            const grade = document.getElementById('st-grade').value;
            const section = document.getElementById('st-section').value;
            
            if(!lastName || !firstName) return alert("Name required");

            try {
                // RTDB push
                const newRef = push(ref(db, `artifacts/${appId}/public/data/students`));
                await set(newRef, {
                    lastName, firstName, middleName, lrn, dob, grade, section,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('new-student-form').reset();
                closeModal('modal-add-student'); 
            } catch(err) {
                console.error(err);
                alert("Error adding student.");
            }
        };

        window.addSubject = async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-sub-name').value;
            const written = parseInt(document.getElementById('new-sub-written').value);
            const performance = parseInt(document.getElementById('new-sub-perf').value);
            const exam = parseInt(document.getElementById('new-sub-exam').value);

            if (written + performance + exam !== 100) return alert("Components must total 100%");

            try {
                const newRef = push(ref(db, `artifacts/${appId}/public/data/subjects`));
                await set(newRef, {
                    name, components: { written, performance, exam }, createdAt: new Date().toISOString()
                });
                document.getElementById('new-subject-form').reset();
            } catch(err) { console.error(err); }
        };

        window.updateScore = async (studentId, activityId, value) => {
            if (value === '') return;
            const existing = scores.find(s => s.studentId === studentId && s.activityId === activityId);
            try {
                if (existing) {
                    await update(ref(db, `artifacts/${appId}/public/data/scores/${existing.id}`), { score: parseFloat(value) });
                } else {
                    const newRef = push(ref(db, `artifacts/${appId}/public/data/scores`));
                    await set(newRef, { studentId, activityId, score: parseFloat(value) });
                }
            } catch(err) { console.error("Score update failed", err); }
        };

        window.saveActivity = async (e) => {
            e.preventDefault();
            const form = document.getElementById('add-activity-form');
            const subjectId = form.dataset.subjectId;
            const title = document.getElementById('act-title').value;
            const type = document.getElementById('act-type').value;
            const max = parseFloat(document.getElementById('act-max').value);
            const date = document.getElementById('act-date').value;

            try {
                const newRef = push(ref(db, `artifacts/${appId}/public/data/activities`));
                await set(newRef, {
                    subjectId, title, componentType: type, maxScore: max, date, gradingPeriod: '1st', createdAt: new Date().toISOString()
                });
                closeModal('modal-add-activity');
                form.reset();
            } catch(err) { console.error(err); }
        };

        window.addBehaviorLog = async (studentId) => {
            const type = prompt("Incident Type (e.g., Late, Disruptive, Absent):");
            if (!type) return;
            const notes = prompt("Detailed Notes:");
            try {
                const newRef = push(ref(db, `artifacts/${appId}/public/data/behaviorLogs`));
                await set(newRef, {
                    studentId, type, notes: notes || '', date: new Date().toISOString().split('T')[0], createdAt: new Date().toISOString()
                });
            } catch(err) { console.error(err); }
        };

        // --- Modals ---

        window.openAddActivityModal = (subjectId) => {
            document.getElementById('add-activity-form').dataset.subjectId = subjectId;
            document.getElementById('modal-add-activity').classList.remove('hidden');
        };

        window.openAddStudentModal = () => {
             document.getElementById('modal-add-student').classList.remove('hidden');
        };

        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
        };

    </script>
    <style>
        @media print {
            body * { visibility: hidden; }
            #printable-report, #printable-report * { visibility: visible; }
            #printable-report { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px; box-shadow: none; border: none; background: white !important; color: black !important; }
            .no-print { display: none; }
        }
        /* Dark Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Fade in only once */
        .fade-in-once {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- App Content -->
    <div id="app-content" class="flex h-full fade-in-once">
        
        <!-- Sidebar -->
        <aside class="w-72 bg-slate-900 border-r border-slate-800 flex-shrink-0 hidden md:flex flex-col z-20 shadow-xl transition-all duration-300">
            <div class="p-8 border-b border-slate-800 bg-gradient-to-br from-slate-900 to-slate-800">
                <div class="h-10 w-10 bg-blue-600 rounded-lg flex items-center justify-center mb-4 shadow-lg shadow-blue-600/30">
                    <i class="fas fa-graduation-cap text-white text-xl"></i>
                </div>
                <h1 class="font-bold text-xl leading-tight text-white tracking-wide">Dr. Pio De Roda</h1>
                <p class="text-xs text-blue-400 mt-1 uppercase tracking-widest">Learning Portal</p>
            </div>
            <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
                <a href="#" onclick="switchView('dashboard')" data-view="dashboard" class="nav-item rounded-xl block px-4 py-3 transition-all flex items-center group">
                    <i class="fas fa-chart-pie w-8 transition-transform group-hover:scale-110"></i> <span class="font-medium">Dashboard</span>
                </a>
                <a href="#" onclick="switchView('gradebook')" data-view="gradebook" class="nav-item rounded-xl block px-4 py-3 transition-all flex items-center group">
                    <i class="fas fa-table w-8 transition-transform group-hover:scale-110"></i> <span class="font-medium">Gradebook</span>
                </a>
                <a href="#" onclick="switchView('students')" data-view="students" class="nav-item rounded-xl block px-4 py-3 transition-all flex items-center group">
                    <i class="fas fa-users w-8 transition-transform group-hover:scale-110"></i> <span class="font-medium">Directory</span>
                </a>
                <a href="#" onclick="switchView('subjects')" data-view="subjects" class="nav-item rounded-xl block px-4 py-3 transition-all flex items-center group">
                    <i class="fas fa-book w-8 transition-transform group-hover:scale-110"></i> <span class="font-medium">Subjects</span>
                </a>
                <a href="#" onclick="switchView('reports')" data-view="reports" class="nav-item rounded-xl block px-4 py-3 transition-all flex items-center group">
                    <i class="fas fa-file-alt w-8 transition-transform group-hover:scale-110"></i> <span class="font-medium">Reports</span>
                </a>
            </nav>
            <div class="p-6 text-xs text-slate-500 text-center border-t border-slate-800">
                System v3.0 &copy; 2025
            </div>
        </aside>

        <!-- Mobile Header -->
        <div class="md:hidden fixed top-0 w-full bg-slate-900 border-b border-slate-800 z-50 flex justify-between items-center p-4 shadow-md">
            <div class="flex items-center gap-3">
                 <div class="h-8 w-8 bg-blue-600 rounded flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-white text-sm"></i>
                </div>
                <span class="font-bold text-white">Portal</span>
            </div>
            <button onclick="toggleMobileMenu()" class="text-slate-300 focus:outline-none p-2 rounded hover:bg-slate-800">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden flex flex-col md:ml-0 mt-16 md:mt-0 w-full relative">
            
            <!-- Dashboard View -->
            <div id="view-dashboard" class="view-section flex-1 overflow-y-auto p-8 fade-in-once">
                <header class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Dashboard Overview</h2>
                        <p class="text-slate-400">Welcome back, Faculty.</p>
                    </div>
                    <div class="h-10 w-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
                        <i class="fas fa-bell text-slate-400"></i>
                    </div>
                </header>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Stat Card 1 -->
                    <div class="bg-gradient-to-br from-blue-900 to-slate-900 p-6 rounded-2xl shadow-lg border border-blue-800/50 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                        <div class="absolute -right-6 -top-6 h-24 w-24 bg-blue-500/20 rounded-full blur-xl group-hover:bg-blue-500/30 transition-all"></div>
                        <div class="relative z-10">
                            <p class="text-blue-200 text-sm font-medium uppercase tracking-wider mb-2">Total Students</p>
                            <p class="text-4xl font-bold text-white" id="dash-total-students">0</p>
                        </div>
                        <i class="fas fa-users absolute right-6 bottom-6 text-blue-500/20 text-5xl"></i>
                    </div>
                    
                    <!-- Stat Card 2 -->
                    <div class="bg-slate-900 p-6 rounded-2xl shadow-lg border border-slate-800 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                         <div class="absolute -right-6 -top-6 h-24 w-24 bg-purple-500/10 rounded-full blur-xl group-hover:bg-purple-500/20 transition-all"></div>
                        <div class="relative z-10">
                            <p class="text-purple-400 text-sm font-medium uppercase tracking-wider mb-2">Active Subjects</p>
                            <p class="text-4xl font-bold text-white" id="dash-subjects">0</p>
                        </div>
                        <i class="fas fa-book absolute right-6 bottom-6 text-purple-500/10 text-5xl"></i>
                    </div>

                    <!-- Stat Card 3 -->
                    <div class="bg-slate-900 p-6 rounded-2xl shadow-lg border border-slate-800 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                        <div class="absolute -right-6 -top-6 h-24 w-24 bg-rose-500/10 rounded-full blur-xl group-hover:bg-rose-500/20 transition-all"></div>
                        <div class="relative z-10">
                            <p class="text-rose-400 text-sm font-medium uppercase tracking-wider mb-2">Needs Attention</p>
                            <p class="text-4xl font-bold text-white" id="dash-at-risk">0</p>
                        </div>
                         <i class="fas fa-exclamation-triangle absolute right-6 bottom-6 text-rose-500/10 text-5xl"></i>
                    </div>
                </div>

                <!-- Empty State Helper -->
                <div id="dash-empty-state" class="hidden mb-8 p-6 bg-slate-900 border border-slate-800 rounded-xl text-center">
                    <i class="fas fa-database text-4xl text-slate-700 mb-4"></i>
                    <h3 class="text-xl font-bold text-white mb-2">Let's Get Started</h3>
                    <p class="text-slate-400 mb-4">Your database is empty. Add a subject and some students to see the charts.</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="switchView('subjects')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-500">Add Subject</button>
                        <button onclick="switchView('students')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-500">Enroll Students</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-slate-900 p-6 rounded-2xl shadow-lg border border-slate-800 lg:col-span-2">
                        <h3 class="font-bold text-lg mb-6 text-slate-200 flex items-center">
                            <span class="w-2 h-6 bg-blue-600 rounded mr-3"></span>
                            Performance Distribution
                        </h3>
                        <div class="h-64">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gradebook View -->
            <div id="view-gradebook" class="view-section hidden flex-1 flex flex-col p-4 md:p-6 h-full max-h-full overflow-hidden fade-in-once">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold text-white">Class Record</h2>
                        <p class="text-slate-400 text-sm">Input grades and track progress</p>
                    </div>
                    <div class="flex space-x-2">
                        <select id="gb-grade-filter" onchange="setGradeFilter(this.value); renderGradebook();" class="bg-slate-800 border border-slate-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                            <option value="all">All Grades</option>
                        </select>
                        <select id="gb-subject-select" onchange="selectedSubjectId = this.value; renderGradebook()" class="bg-slate-800 border border-slate-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                            <option value="all">Summary View</option>
                        </select>
                    </div>
                </div>
                <div class="flex-1 bg-slate-900 rounded-xl shadow-lg border border-slate-800 overflow-hidden relative flex flex-col min-h-0" id="gradebook-container">
                    <!-- Gradebook Table Injected Here -->
                </div>
            </div>

            <!-- Students View -->
            <div id="view-students" class="view-section hidden flex-1 overflow-y-auto p-8 fade-in-once">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Directory</h2>
                        <p class="text-slate-400">Manage student profiles and enrollment</p>
                    </div>
                    <div class="flex gap-2">
                         <select id="st-grade-filter" onchange="setGradeFilter(this.value); renderStudents();" class="bg-slate-800 border border-slate-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                            <option value="all">All Grades</option>
                        </select>
                        <button onclick="openAddStudentModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg shadow-lg shadow-blue-900/50 transition-all font-bold flex items-center">
                            <i class="fas fa-plus mr-2"></i> Enroll Student
                        </button>
                    </div>
                </div>
                
                <!-- Students List -->
                <div id="students-list">
                    <!-- Student items injected here -->
                </div>
            </div>

            <!-- Subjects View -->
            <div id="view-subjects" class="view-section hidden flex-1 overflow-y-auto p-8 fade-in-once">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">Subjects Configuration</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Add Subject Form -->
                    <div class="bg-slate-900 p-6 rounded-2xl shadow-lg border border-slate-800 h-fit">
                        <h3 class="font-bold text-lg mb-6 text-white">New Subject</h3>
                        <form id="new-subject-form" onsubmit="addSubject(event)">
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                                <input type="text" id="new-sub-name" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white" placeholder="e.g. Mathematics" required>
                            </div>
                            
                            <!-- DepEd Preset -->
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">DepEd Standard Preset</label>
                                <select id="deped-preset" onchange="applyDepEdPreset()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
                                    <option value="">Select Preset...</option>
                                    <option value="lang">Languages / AP / EsP (30/50/20)</option>
                                    <option value="math">Math / Science (40/40/20)</option>
                                    <option value="mapeh">MAPEH / EPP / TLE (20/60/20)</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label class="block text-xs font-bold text-blue-400 uppercase">Grading Weights (%)</label>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mb-6">
                                <div>
                                    <label class="text-[10px] text-slate-500 block text-center mb-1">Written</label>
                                    <input type="number" id="new-sub-written" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-2 text-center text-white font-bold" value="30">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 block text-center mb-1">Perf.</label>
                                    <input type="number" id="new-sub-perf" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-2 text-center text-white font-bold" value="50">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 block text-center mb-1">Exam</label>
                                    <input type="number" id="new-sub-exam" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-2 text-center text-white font-bold" value="20">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-500 font-bold transition-colors">Add Subject</button>
                        </form>
                    </div>

                    <!-- Subjects List -->
                    <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4" id="subjects-list">
                        <!-- Subjects injected here -->
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="view-reports" class="view-section hidden flex-1 overflow-y-auto p-6 bg-slate-900">
                <div class="max-w-4xl mx-auto" id="report-preview">
                    <!-- Report content injected here -->
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->

    <!-- Add Activity Modal -->
    <div id="modal-add-activity" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-slate-900 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md p-8 transform transition-all animate-slide-up">
            <h3 class="text-xl font-bold mb-6 text-white">Create Assessment</h3>
            <form id="add-activity-form" onsubmit="saveActivity(event)">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Activity Title</label>
                    <input type="text" id="act-title" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-blue-500 focus:outline-none" placeholder="e.g. Quiz #1" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                    <select id="act-type" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-blue-500 focus:outline-none">
                        <option value="written">Written Work</option>
                        <option value="performance">Performance Task</option>
                        <option value="exam">Quarterly Assessment</option>
                    </select>
                </div>
                <div class="flex gap-4 mb-6">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Max Score</label>
                        <input type="number" id="act-max" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-blue-500 focus:outline-none" value="10" required>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                        <input type="date" id="act-date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-blue-500 focus:outline-none" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('modal-add-activity')" class="px-5 py-2 text-slate-400 hover:text-white transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 shadow-lg shadow-blue-600/30">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Student Modal (New) -->
    <div id="modal-add-student" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-lg p-8 transform transition-all animate-slide-up">
            <h3 class="text-xl font-bold mb-6 text-white flex items-center">
                <span class="bg-blue-600 p-2 rounded-lg mr-3 shadow-lg shadow-blue-600/20"><i class="fas fa-user-plus text-sm"></i></span>
                Enroll New Student
            </h3>
            <form id="new-student-form" onsubmit="addStudent(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Last Name</label>
                        <input type="text" id="st-lastname" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">First Name</label>
                        <input type="text" id="st-firstname" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">M.I.</label>
                        <input type="text" id="st-middlename" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">LRN (Learner Ref No.)</label>
                    <input type="text" id="st-lrn" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none" placeholder="12-digit LRN">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Grade</label>
                        <input type="text" id="st-grade" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none" placeholder="e.g. 6">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Section</label>
                        <input type="text" id="st-section" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none" placeholder="e.g. Rizal">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date of Birth</label>
                    <input type="date" id="st-dob" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none">
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('modal-add-student')" class="px-5 py-2 text-slate-400 hover:text-white transition-colors">Cancel</button>
                    <button type="submit" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-2 px-6 rounded-xl hover:shadow-lg hover:shadow-blue-600/30 transition-all">
                        Save Profile
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>
