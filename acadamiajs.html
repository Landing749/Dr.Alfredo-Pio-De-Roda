<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcademiaJS | Apex Pro v12.0</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <style>
        :root {
            --bs-body-bg: #0b0f19;
            --bs-body-color: #e2e8f0;
            --sidebar-width: 280px;
            --navbar-height: 70px;
            --primary-color: #6366f1; /* Indigo */
            --accent-color: #8b5cf6; /* Violet */
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --card-bg: #151b2b;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
            background-color: var(--bs-body-bg);
            background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                              radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            padding-top: var(--navbar-height);
        }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: var(--card-bg);
            border: var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            transition: transform 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border: none;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        /* --- LOGIN UX --- */
        .login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        
        .login-card {
            width: 100%; max-width: 420px;
            background: rgba(20, 25, 40, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 3rem;
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: floatUp 0.6s ease-out;
            text-align: center; /* Center align content */
        }
        @keyframes floatUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Fixed Login Icon */
        .login-icon-box {
            width: 80px; height: 80px;
            margin: 0 auto 1.5rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            font-size: 2.5rem; color: var(--primary-color);
        }

        .form-control, .form-select {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 12px;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            color: white;
        }
        .form-floating label { color: #94a3b8; }

        /* --- NAVIGATION --- */
        .main-navbar {
            height: var(--navbar-height);
            background: rgba(11, 15, 25, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 1040;
        }

        .sidebar {
            background-color: #0f172a !important;
            border-right: 1px solid rgba(255,255,255,0.05) !important;
            width: var(--sidebar-width);
            height: calc(100vh - var(--navbar-height));
            position: fixed;
            top: var(--navbar-height);
            left: 0;
            z-index: 1030;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding: 1.5rem 1rem;
        }

        .nav-link {
            color: #94a3b8; margin-bottom: 4px; padding: 12px 16px; border-radius: 10px;
            display: flex; align-items: center; font-weight: 500; transition: all 0.2s;
        }
        .nav-link i { font-size: 1.2rem; margin-right: 12px; width: 24px; text-align: center; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: #fff; transform: translateX(4px); }
        .nav-link.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15), transparent);
            color: #fff; border-left: 3px solid var(--primary-color); border-radius: 4px 10px 10px 4px;
        }

        .main-content {
            margin-left: var(--sidebar-width); padding: 2rem;
            min-height: calc(100vh - var(--navbar-height)); transition: margin-left 0.3s ease;
        }

        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1rem; }
            .sidebar-backdrop {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1020; display: none; backdrop-filter: blur(2px);
            }
            .sidebar-backdrop.show { display: block; }
        }

        /* --- WIDGETS & MODULES --- */
        .stat-card {
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px; padding: 1.5rem; transition: transform 0.2s;
            position: relative; overflow: hidden;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.1); }
        .stat-card::after {
            content: ''; position: absolute; top: -50%; right: -50%; width: 100px; height: 100px;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            border-radius: 50%; pointer-events: none;
        }

        .calendar-day { 
            min-height: 110px; border: 1px solid #334155; background: #1e293b; padding: 8px; 
            cursor: pointer; transition: all 0.2s; border-radius: 8px; margin: 2px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .calendar-day:hover { background: #2a3855; z-index: 2; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .calendar-event { 
            font-size: 0.7em; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; color: white;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .evt-exam { background: #ef4444; } .evt-holiday { background: #10b981; } .evt-activity { background: #3b82f6; }

        .chat-container { 
            height: 450px; overflow-y: auto; background: #0f172a; padding: 20px; border-radius: 16px;
            display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; border: 1px solid rgba(255,255,255,0.05);
        }
        .chat-msg { display: flex; align-items: flex-end; max-width: 80%; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .chat-msg.mine { align-self: flex-end; flex-direction: row-reverse; }
        .chat-avatar { 
            width: 32px; height: 32px; border-radius: 50%; background: #475569; margin: 0 8px; 
            background-size: cover; flex-shrink: 0; border: 2px solid #1e293b; 
        }
        .chat-bubble { 
            padding: 10px 16px; border-radius: 18px; position: relative; font-size: 0.9rem; line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); word-wrap: break-word;
        }
        .chat-msg.mine .chat-bubble { background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
        .chat-msg.theirs .chat-bubble { background: #334155; color: #e2e8f0; border-bottom-left-radius: 4px; }

        .id-card-container {
            background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
            border: 2px solid #444; border-radius: 20px; padding: 30px; width: 340px; text-align: center; margin: 0 auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); position: relative; overflow: hidden;
        }
        .id-card-photo { width: 100px; height: 100px; background: #555; border-radius: 50%; margin: 0 auto 15px; background-size: cover; background-position: center; border: 3px solid var(--primary-color); }

        #offline-indicator {
            display: none; background-color: #ef4444; color: white; text-align: center; padding: 8px;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 3000; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .content-tab { display: none; opacity: 0; transition: opacity 0.3s; }
        .content-tab.active-tab { display: block; opacity: 1; }
        
        .swal2-container { z-index: 9999 !important; }
        .nav-avatar { width: 40px; height: 40px; border-radius: 50%; background-size: cover; background-position: center; background-color: #475569; border: 2px solid var(--primary-color); cursor: pointer; }
    </style>
</head>
<body>

    <div id="offline-indicator"><i class="bi bi-wifi-off me-2"></i> OFFLINE MODE</div>

    <!-- LOADING SCREEN -->
    <div id="loading-overlay" class="position-fixed w-100 h-100 bg-dark z-3 d-flex flex-column justify-content-center align-items-center" style="opacity:1; transition: opacity 0.5s;">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h5 class="text-white letter-spacing-2 font-monospace">ACADEMIA<span class="text-primary fw-bold">JS</span></h5>
    </div>

    <!-- AUTH SECTION -->
    <div id="auth-container" class="login-wrapper d-none">
        <div class="login-card">
            <div class="login-icon-box">
                <i class="bi bi-mortarboard-fill"></i>
            </div>
            <h2 class="fw-bold text-white mb-0">AcademiaJS</h2>
            <p class="text-white-50 mb-4">Apex Pro v12.0</p>
            
            <ul class="nav nav-pills nav-fill mb-4 bg-black bg-opacity-25 rounded-pill p-1 border border-secondary border-opacity-25" role="tablist">
                <li class="nav-item"><button class="nav-link active rounded-pill" id="login-tab-btn" data-bs-toggle="tab" data-bs-target="#login-pane">Login</button></li>
                <li class="nav-item"><button class="nav-link rounded-pill" id="register-tab-btn" data-bs-toggle="tab" data-bs-target="#register-pane">Register</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="login-pane">
                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="login-email" placeholder="name@example.com">
                        <label>Email address</label>
                    </div>
                    <div class="form-floating mb-4">
                        <input type="password" class="form-control" id="login-password" placeholder="Password">
                        <label>Password</label>
                    </div>
                    <button type="button" class="btn btn-primary w-100 fw-bold py-3 rounded-xl" id="btn-login" onclick="app.auth.login()">
                        <span class="d-none spinner-border spinner-border-sm me-2"></span> Sign In
                    </button>
                    <div class="text-center mt-3"><a href="#" class="text-white-50 small text-decoration-none hover-white" onclick="app.auth.forgotPassword()">Forgot Password?</a></div>
                </div>
                <div class="tab-pane fade" id="register-pane">
                    <div class="form-floating mb-2"><input type="text" class="form-control" id="reg-username" placeholder="Full Name"><label>Full Name</label></div>
                    <div class="form-floating mb-2"><input type="email" class="form-control" id="reg-email" placeholder="name@example.com"><label>Email address</label></div>
                    <div class="form-floating mb-4"><input type="password" class="form-control" id="reg-password" placeholder="Password"><label>Password (Min 6)</label></div>
                    <button type="button" class="btn btn-success w-100 fw-bold py-3 rounded-xl" id="btn-register" onclick="app.auth.register()">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="d-none">
        <div class="sidebar-backdrop" onclick="app.ui.closeSidebar()"></div>

        <!-- TOP NAVBAR -->
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top main-navbar px-4 shadow-sm">
            <div class="container-fluid g-0">
                <button class="btn btn-outline-secondary me-3 d-lg-none border-0" onclick="app.ui.openSidebar()"><i class="bi bi-list fs-4"></i></button>
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <i class="bi bi-mortarboard-fill me-2 text-primary"></i> <span class="fw-bold tracking-tight">AcademiaJS</span>
                </a>
                <div class="ms-auto d-flex align-items-center gap-3">
                    <div class="text-end d-none d-md-block">
                        <div id="nav-user-email" class="fw-bold text-white small">...</div>
                        <div id="nav-user-role" class="text-white-50 small text-uppercase" style="font-size: 0.7rem;">...</div>
                    </div>
                    <div class="dropdown">
                        <div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center nav-avatar" id="nav-user-avatar" data-bs-toggle="dropdown">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark shadow border-0 mt-3 p-2 rounded-4">
                            <li><a class="dropdown-item rounded-3 py-2" href="#" onclick="app.ui.showTab('settings')"><i class="bi bi-person-circle me-2"></i> Profile</a></li>
                            <li><hr class="dropdown-divider bg-secondary opacity-25"></li>
                            <li><a class="dropdown-item rounded-3 py-2 text-danger" href="#" onclick="app.auth.logout()"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- SIDEBAR -->
        <div class="sidebar d-flex flex-column">
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item mb-1"><a href="#" class="nav-link active" onclick="app.ui.showTab('dashboard')"><i class="bi bi-grid-fill"></i> Dashboard</a></li>
                <li class="nav-item admin-only"><a href="#" class="nav-link text-warning" onclick="app.ui.showTab('admin')"><i class="bi bi-shield-fill-check"></i> Admin Panel</a></li>
                <li class="nav-item teacher-only"><a href="#" class="nav-link text-info" onclick="app.ui.showTab('teachernet')"><i class="bi bi-chat-quote-fill"></i> TeacherNet</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" onclick="app.ui.showTab('messages')"><i class="bi bi-megaphone-fill"></i> Announcements</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" onclick="app.ui.showTab('calendar')"><i class="bi bi-calendar-week-fill"></i> Calendar</a></li>
                <li class="nav-item teacher-only"><a href="#" class="nav-link" onclick="app.ui.showTab('attendance')"><i class="bi bi-qr-code"></i> Attendance</a></li>
                <li class="nav-item teacher-only"><a href="#" class="nav-link" onclick="app.ui.showTab('discipline')"><i class="bi bi-exclamation-octagon-fill"></i> Discipline</a></li>
                <li class="nav-item teacher-only"><a href="#" class="nav-link" onclick="app.ui.showTab('students')"><i class="bi bi-people-fill"></i> Students</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" onclick="app.ui.showTab('excuses')"><i class="bi bi-file-medical-fill"></i> Excuses</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" onclick="app.ui.showTab('gamification')"><i class="bi bi-trophy-fill"></i> Gamification</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" onclick="app.ui.showTab('reports')"><i class="bi bi-bar-chart-line-fill"></i> Analytics</a></li>
                <li class="nav-item mt-4 border-top border-secondary border-opacity-25 pt-3"><a href="#" class="nav-link text-muted" onclick="app.ui.showTab('settings')"><i class="bi bi-gear-fill"></i> Settings</a></li>
            </ul>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- DASHBOARD -->
            <div id="tab-dashboard" class="content-tab active-tab">
                <div class="d-flex justify-content-between align-items-end mb-4">
                    <div><h2 class="fw-bold mb-0 text-white">Overview</h2><p class="text-white-50 mb-0">System Dashboard</p></div>
                    <span class="badge bg-primary bg-opacity-25 text-primary border border-primary border-opacity-25 rounded-pill px-3 py-2">Apex 12.0</span>
                </div>
                
                <!-- PARENT DASHBOARD -->
                <div id="dashboard-parent-view" class="d-none">
                    <div class="glass-panel p-4 mb-4" id="parent-linker">
                        <h5 class="text-primary mb-3"><i class="bi bi-link-45deg"></i> Link Student</h5>
                        <div class="input-group"><input type="text" id="parent-child-email" class="form-control" placeholder="Enter student email..."><button type="button" class="btn btn-primary" onclick="app.parent.linkChild()">Connect</button></div>
                    </div>
                    <div id="parent-stats" class="d-none">
                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><div class="stat-card h-100"><h6 class="text-muted text-uppercase mb-2">Attendance</h6><h2 class="text-success fw-bold counter-anim" id="p-att">0</h2></div></div>
                            <div class="col-md-4"><div class="stat-card h-100"><h6 class="text-muted text-uppercase mb-2">Incidents</h6><h2 class="text-warning fw-bold counter-anim" id="p-inc">0</h2></div></div>
                            <div class="col-md-4"><div class="stat-card h-100"><h6 class="text-muted text-uppercase mb-2">Points</h6><h2 class="text-info fw-bold counter-anim" id="p-pts">0</h2></div></div>
                        </div>
                    </div>
                </div>

                <!-- TEACHER/ADMIN DASHBOARD -->
                <div id="dashboard-teacher-view">
                    <div class="glass-panel p-3 mb-4">
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-outline-light btn-sm rounded-pill" onclick="app.ui.showTab('attendance')"><i class="bi bi-upc-scan"></i> Scan</button>
                            <button type="button" class="btn btn-outline-light btn-sm rounded-pill" onclick="app.ui.showTab('discipline')"><i class="bi bi-flag"></i> Report</button>
                            <button type="button" class="btn btn-outline-light btn-sm rounded-pill" onclick="app.classroom.createSection()"><i class="bi bi-plus"></i> Class</button>
                        </div>
                    </div>
                    <div class="row g-4 mb-4">
                        <div class="col-md-3"><div class="stat-card h-100"><h6 class="text-muted text-uppercase small">Students</h6><h2 class="fw-bold counter-anim" id="stat-students">0</h2></div></div>
                        <div class="col-md-3"><div class="stat-card h-100"><h6 class="text-muted text-uppercase small">Attendance</h6><h2 class="fw-bold text-success counter-anim" id="stat-attendance">0%</h2></div></div>
                        <div class="col-md-3"><div class="stat-card h-100"><h6 class="text-muted text-uppercase small">Incidents</h6><h2 class="fw-bold text-warning counter-anim" id="stat-incidents">0</h2></div></div>
                        <div class="col-md-3"><div class="stat-card h-100"><h6 class="text-muted text-uppercase small">Alerts</h6><h2 class="fw-bold text-danger counter-anim" id="stat-alerts">0</h2></div></div>
                    </div>
                    <div class="glass-panel p-4"><canvas id="attendanceChart" height="80"></canvas></div>
                </div>
            </div>

            <!-- ATTENDANCE -->
            <div id="tab-attendance" class="content-tab">
                <div class="row">
                    <div class="col-md-5">
                        <div class="glass-panel p-4 text-center h-100">
                            <h4 class="text-info mb-4"><i class="bi bi-upc-scan"></i> Scanner</h4>
                            <div id="reader" style="width: 100%; border-radius: 12px; overflow: hidden; background: #000; margin-bottom: 1rem;"></div>
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" id="btn-start-scan" class="btn btn-success" onclick="app.attendance.startScanner()">Start Camera</button>
                                <button type="button" id="btn-stop-scan" class="btn btn-danger d-none" onclick="app.attendance.stopScanner()">Stop Camera</button>
                            </div>
                            <hr class="border-secondary">
                            <div class="form-floating mb-2"><input type="text" id="scanner-input" class="form-control text-center fs-5" placeholder="Type ID"><label class="text-center w-100">Or Type ID</label></div>
                            <input type="date" id="manual-date" class="form-control mb-3 text-center">
                            <button type="button" class="btn btn-primary w-100" onclick="app.attendance.processScan()">Manual Submit</button>
                            <div id="scan-result" class="mt-3 fw-bold min-h-30"></div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="glass-panel p-4 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-3"><h5>Recent Logs</h5><button type="button" class="btn btn-sm btn-success" onclick="app.attendance.exportSF2()"><i class="bi bi-download"></i> SF2 Export</button></div>
                            <ul id="recent-attendance" class="list-group list-group-flush overflow-auto" style="max-height: 400px;"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADMIN -->
            <div id="tab-admin" class="content-tab">
                <h2 class="text-warning mb-3">Admin Console</h2>
                <div class="glass-panel p-4 mb-4">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-dark border-secondary"><i class="bi bi-search"></i></span>
                        <input type="text" id="admin-search" class="form-control" placeholder="Search users..." onkeyup="app.admin.filterUsers()">
                    </div>
                    
                    <ul class="nav nav-tabs border-secondary mb-3" id="adminTabs" role="tablist">
                        <li class="nav-item"><button type="button" class="nav-link active text-white" data-bs-toggle="tab" data-bs-target="#tab-list-students">Students <span id="count-student" class="badge bg-secondary ms-1">0</span></button></li>
                        <li class="nav-item"><button type="button" class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#tab-list-teachers">Teachers <span id="count-teacher" class="badge bg-secondary ms-1">0</span></button></li>
                        <li class="nav-item"><button type="button" class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#tab-list-admins">Admins <span id="count-admin" class="badge bg-secondary ms-1">0</span></button></li>
                        <li class="nav-item"><button type="button" class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#tab-list-parents">Parents <span id="count-parent" class="badge bg-secondary ms-1">0</span></button></li>
                    </ul>

                    <div class="tab-content table-responsive" style="max-height: 500px;">
                        <div class="tab-pane fade show active" id="tab-list-students"><table class="table table-dark table-hover mb-0 align-middle"><tbody id="list-students"></tbody></table></div>
                        <div class="tab-pane fade" id="tab-list-teachers"><table class="table table-dark table-hover mb-0 align-middle"><tbody id="list-teachers"></tbody></table></div>
                        <div class="tab-pane fade" id="tab-list-admins"><table class="table table-dark table-hover mb-0 align-middle"><tbody id="list-admins"></tbody></table></div>
                        <div class="tab-pane fade" id="tab-list-parents"><table class="table table-dark table-hover mb-0 align-middle"><tbody id="list-parents"></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- CALENDAR -->
            <div id="tab-calendar" class="content-tab">
                <div class="d-flex justify-content-between align-items-center mb-3"><h2>Calendar</h2><div class="teacher-only"><button type="button" class="btn btn-primary btn-sm" onclick="app.calendar.expandDay(new Date().toISOString().split('T')[0])">+ Add Event</button></div></div>
                <div class="glass-panel p-3">
                    <div class="d-flex justify-content-between mb-3 align-items-center"><button type="button" class="btn btn-sm btn-outline-secondary" onclick="app.calendar.prevMonth()">&larr;</button><h4 id="calendar-month-display" class="m-0 fw-bold"></h4><button type="button" class="btn btn-sm btn-outline-secondary" onclick="app.calendar.nextMonth()">&rarr;</button></div>
                    <div class="row row-cols-7 g-1 text-center small text-muted mb-2"><div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div></div>
                    <div class="row row-cols-7 g-1 text-center" id="calendar-grid"></div>
                </div>
            </div>

            <!-- EXCUSES -->
            <div id="tab-excuses" class="content-tab">
                <div class="row">
                    <div class="col-md-4">
                        <div class="glass-panel p-4">
                            <h5>New Excuse</h5>
                            <div id="excuse-student-wrapper" class="mb-2"><input type="text" id="excuse-email-input" class="form-control" placeholder="Student Email" disabled><select id="excuse-student-select" class="form-select d-none"></select></div>
                            <input type="date" id="excuse-date" class="form-control mb-2">
                            <select id="excuse-reason" class="form-select mb-2"><option>Medical</option><option>Family</option><option>Other</option></select>
                            <textarea id="excuse-note" class="form-control mb-2" placeholder="Details..."></textarea>
                            <button type="button" class="btn btn-primary w-100" onclick="app.excuses.submit()">Submit</button>
                        </div>
                    </div>
                    <div class="col-md-8"><div class="glass-panel p-4 h-100"><h5 class="mb-3">History</h5><div id="excuse-list" class="list-group overflow-auto" style="max-height: 500px;"></div></div></div>
                </div>
            </div>
            
            <!-- TEACHERNET -->
            <div id="tab-teachernet" class="content-tab">
                <div class="glass-panel h-100 d-flex flex-column">
                    <div class="p-3 border-bottom border-secondary d-flex justify-content-between"><h5 class="mb-0 text-info"><i class="bi bi-chat-dots-fill"></i> TeacherNet</h5><small class="text-muted">Staff Channel</small></div>
                    <div id="teachernet-chat" class="chat-container flex-grow-1"></div>
                    <div class="p-3 border-top border-secondary"><div class="input-group"><input type="text" id="teachernet-input" class="form-control rounded-pill" placeholder="Message..." onkeypress="if(event.key==='Enter') app.teachernet.send()"><button type="button" class="btn btn-primary rounded-pill ms-2" onclick="app.teachernet.send()"><i class="bi bi-send-fill"></i></button></div></div>
                </div>
            </div>

            <!-- OTHER TABS -->
            <div id="tab-messages" class="content-tab"><div class="row"><div class="col-md-4 mb-3 teacher-only"><div class="glass-panel p-3"><h5>Post Announcement</h5><input id="msg-title" class="form-control mb-2" placeholder="Title"><textarea id="msg-body" class="form-control mb-2" placeholder="Body"></textarea><button type="button" class="btn btn-primary w-100" onclick="app.messages.post()">Post</button></div></div><div class="col-md-8" id="messages-list"></div></div></div>
            <div id="tab-discipline" class="content-tab"><div class="row"><div class="col-md-4 teacher-only"><div class="glass-panel p-3 mb-3"><h5>Report</h5><select id="inc-severity" class="form-select mb-2"><option>Minor</option><option>Major</option><option>Critical</option></select><input id="inc-student-email" class="form-control mb-2" placeholder="Student Email"><textarea id="inc-desc" class="form-control mb-2" placeholder="Desc"></textarea><button type="button" class="btn btn-danger w-100" onclick="app.discipline.submitReport()">Submit</button></div></div><div class="col-md-8"><div id="incident-list"></div></div></div></div>
            <div id="tab-students" class="content-tab"><div class="row"><div class="col-md-4"><div class="glass-panel p-3 mb-3"><h5>Create Class</h5><input id="new-section-name" class="form-control mb-2"><button type="button" class="btn btn-success w-100" onclick="app.classroom.createSection()">Create</button></div><div class="glass-panel p-3"><h5>My Classes</h5><ul id="my-sections-list" class="list-group list-group-flush"></ul></div></div><div class="col-md-8"><div class="glass-panel p-3"><h5>Unassigned</h5><div class="input-group mb-2"><span class="input-group-text">Assign:</span><select id="select-target-section" class="form-select"></select></div><table class="table table-dark"><tbody id="unassigned-list"></tbody></table></div></div></div></div>
            <div id="tab-gamification" class="content-tab"><div class="row"><div class="col-md-8"><table class="table table-dark table-striped"><thead><tr><th>Rank</th><th>Name</th><th>Pts</th><th>Badge</th></tr></thead><tbody id="leaderboard-list"></tbody></table></div><div class="col-md-4 teacher-only"><div class="glass-panel p-3"><h5>Give Points</h5><input id="award-email" class="form-control mb-2" placeholder="Student Email"><input type="number" id="award-amount" class="form-control mb-2" placeholder="Points"><button type="button" class="btn btn-primary w-100" onclick="app.gamification.givePoints()">Award</button></div></div></div></div>
            <div id="tab-reports" class="content-tab"><div class="row"><div class="col-md-6"><div class="glass-panel p-3 border-danger mb-3"><h5>At-Risk</h5><ul id="ai-risk-list" class="list-group"></ul></div></div><div class="col-md-6"><button type="button" class="btn btn-success w-100 p-4" onclick="app.reports.exportCSV()">Download CSV Report</button></div></div></div>
            <div id="tab-policies" class="content-tab"><div class="glass-panel p-4"><h2>Policies</h2><p>1. Attendance Mandatory.<br>2. Respect All.</p><hr><button type="button" class="btn btn-outline-success" onclick="Swal.fire('Signed','','success')">Acknowledge</button></div></div>
            <div id="tab-settings" class="content-tab"><div class="glass-panel p-4"><h2>Settings</h2>
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <span>Desktop Notifications</span>
                    <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="notif-toggle" onchange="app.settings.toggleNotif()"></div>
                </div>
                <div class="mb-3"><label>Profile Pic</label><div class="input-group"><input type="file" id="settings-avatar-file" class="form-control"><button type="button" class="btn btn-primary" onclick="app.settings.uploadAvatar()">Upload</button></div></div>
            </div></div>

        </div>
    </div>

    <!-- STUDENT ID MODAL -->
    <div id="student-id-view" class="position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-75 z-3 d-flex justify-content-center align-items-center d-none">
        <div class="position-relative animate-in"><button type="button" class="btn btn-close btn-close-white position-absolute top-0 end-0 m-3" onclick="document.getElementById('student-id-view').classList.add('d-none')"></button><div class="id-card-container"><div class="id-card-header"><h5>STUDENT ID</h5></div><div id="my-id-photo" class="id-card-photo shadow"></div><h4 id="my-id-name" class="mt-3 fw-bold">Student Name</h4><p class="text-muted small text-uppercase" id="my-id-email">email@school.edu</p><div id="my-id-qrcode" class="bg-white p-2 d-inline-block rounded mt-2 shadow-sm"></div><div class="mt-4"><button type="button" class="btn btn-outline-light btn-sm w-100 rounded-pill py-2" onclick="app.student.downloadID()">Save to Device</button></div></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, get, query, orderByChild, equalTo, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyBHkWxtXJSGVHZQQ_dis3r7QD_vAhhyXK4", authDomain: "academiajs-31cb8.firebaseapp.com", databaseURL: "https://academiajs-31cb8-default-rtdb.firebaseio.com", projectId: "academiajs-31cb8", storageBucket: "academiajs-31cb8.firebasestorage.app", messagingSenderId: "51260952616", appId: "1:51260952616:web:f5f071621cdf7e901b251d", measurementId: "G-RQJZWC3T0V" };
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/damr6r9op/upload";
        const CLOUDINARY_PRESET = "org-resources";

        const appInstance = initializeApp(firebaseConfig);
        const auth = getAuth(appInstance);
        const db = getDatabase(appInstance);
        
        setPersistence(auth, browserLocalPersistence).catch(console.error);

        let currentUser = null, currentRole = null, linkedChildEmail = null;
        let calDate = new Date();
        let sessionTimer;
        const resetSession = () => { clearTimeout(sessionTimer); if(currentUser) sessionTimer = setTimeout(() => { Swal.fire('Timeout', 'Session expired', 'warning').then(()=>app.auth.logout()); }, 1800000); };
        window.onclick = resetSession; window.onkeypress = resetSession;

        // Offline
        let isOnline = navigator.onLine;
        const offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
        window.addEventListener('offline', () => { isOnline = false; document.getElementById('offline-indicator').style.display='block'; });
        window.addEventListener('online', () => { isOnline = true; document.getElementById('offline-indicator').style.display='none'; processOfflineQueue(); });
        const addToQueue = (action, data) => { offlineQueue.push({action, data, time:Date.now()}); localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue)); Swal.fire({toast:true, icon:'warning', title:'Queued Offline', position:'top-end'}); };
        const processOfflineQueue = async () => { if(offlineQueue.length) { for(const i of offlineQueue) { if(i.action==='attendance') await push(ref(db,'attendance'), i.data); } localStorage.setItem('offlineQueue','[]'); Swal.fire({toast:true, icon:'success', title:'Synced Data', position:'top-end'}); }};

        // Helpers
        const toggleView = (loggedIn) => {
            const authDiv = document.getElementById('auth-container');
            const appDiv = document.getElementById('app-container');
            const loader = document.getElementById('loading-overlay');
            if(loader) { loader.style.opacity='0'; setTimeout(()=>loader.remove(),500); }
            if(loggedIn) { authDiv.classList.add('d-none'); appDiv.classList.remove('d-none'); } 
            else { authDiv.classList.remove('d-none'); appDiv.classList.add('d-none'); }
        };
        const sanitize = (str) => DOMPurify.sanitize(str);
        
        const animateCounters = () => {
            document.querySelectorAll('.counter-anim').forEach(c => {
                const target = +c.innerText.replace('%','');
                let count = 0; const inc = target / 50;
                const timer = setInterval(() => { count += inc; if(count >= target) { c.innerText = target + (c.id==='stat-attendance'?'%':''); clearInterval(timer); } else c.innerText = Math.ceil(count) + (c.id==='stat-attendance'?'%':''); }, 20);
            });
        };

        window.app = {
            auth: {
                login: async () => {
                    const e = document.getElementById('login-email').value; const p = document.getElementById('login-password').value;
                    const btn = document.getElementById('btn-login'); btn.disabled=true; btn.firstElementChild.classList.remove('d-none');
                    try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { Swal.fire('Error', err.message, 'error'); btn.disabled=false; btn.firstElementChild.classList.add('d-none'); }
                },
                register: async () => {
                    const e = document.getElementById('reg-email').value; const p = document.getElementById('reg-password').value; const n = sanitize(document.getElementById('reg-username').value);
                    if(p.length < 6) return Swal.fire('Weak Password','Must be 6+ chars','warning');
                    const btn = document.getElementById('btn-register'); btn.disabled=true; btn.firstElementChild.classList.remove('d-none');
                    try { const c = await createUserWithEmailAndPassword(auth, e, p); await set(ref(db, 'users/'+c.user.uid), { email:e, username:n, role:'student', points:50, createdAt:Date.now() }); Swal.fire('Success', 'Welcome!', 'success'); } catch(err) { Swal.fire('Error', err.message, 'error'); btn.disabled=false; btn.firstElementChild.classList.add('d-none'); }
                },
                forgotPassword: async () => { const { value: email } = await Swal.fire({ input: 'email', inputLabel: 'Enter email' }); if(email) { sendPasswordResetEmail(auth, email).then(()=>Swal.fire('Sent','Check inbox','success')).catch(e=>Swal.fire('Error',e.message,'error')); } },
                logout: () => signOut(auth)
            },
            init: async (user) => {
                const snap = await get(ref(db, 'users/'+user.uid)); const d = snap.val();
                if(d) {
                    currentUser = user; currentRole = d.role || 'student'; currentUser.email = d.email; currentUser.username = d.username;
                    document.getElementById('nav-user-email').innerText = d.username || d.email; document.getElementById('nav-user-role').innerText = currentRole.toUpperCase();
                    if(d.avatar) document.getElementById('nav-user-avatar').style.backgroundImage = `url(${d.avatar})`;

                    const isS = currentRole==='student', isT = currentRole==='teacher', isA = currentRole==='admin', isP = currentRole==='parent';
                    document.querySelectorAll('.teacher-only').forEach(e => e.classList.toggle('d-none', isS || isP));
                    document.querySelectorAll('.student-only').forEach(e => e.classList.toggle('d-none', !isS));
                    document.querySelectorAll('.admin-only').forEach(e => e.classList.toggle('d-none', !isA));

                    const exInput = document.getElementById('excuse-email-input'); const exSelect = document.getElementById('excuse-student-select');
                    if(isT || isA) { exInput.classList.add('d-none'); exSelect.classList.remove('d-none'); app.classroom.loadStudentDropdown(); } 
                    else { exInput.classList.remove('d-none'); exSelect.classList.add('d-none'); exInput.value = isP && d.linkedChild ? d.linkedChild : currentUser.email; }

                    if(isP) { document.getElementById('dashboard-parent-view').classList.remove('d-none'); document.getElementById('dashboard-teacher-view').classList.add('d-none'); if(d.linkedChild) app.parent.loadChild(d.linkedChild); }

                    toggleView(true); animateCounters();
                    
                    app.charts.init(); app.calendar.render(); app.messages.load();
                    if(isT||isA) { app.attendance.loadRecent(); app.discipline.loadIncidents(); app.teachernet.load(); app.classroom.loadSections(); }
                    if(isA) { app.admin.loadUsers(); app.admin.loadAudit(); }
                    if(isS) app.student.genID(d);
                    app.excuses.load(); app.gamification.loadLeaderboard(); app.reports.runAI(); app.notifications.listen(user.uid);
                    
                    if(Notification.permission === 'granted') document.getElementById('notif-toggle').checked = true;
                } else { Swal.fire('Error','No profile found','error'); signOut(auth); }
            },
            ui: { 
                showTab: (t) => { 
                    if(window.innerWidth < 992) app.ui.closeSidebar(); 
                    document.querySelectorAll('.content-tab').forEach(e => { e.classList.remove('active-tab'); e.style.display='none'; }); 
                    const target = document.getElementById('tab-'+t); target.style.display='block'; setTimeout(()=>target.classList.add('active-tab'), 10); 
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); 
                    const nav = document.querySelector(`.nav-link[onclick="app.ui.showTab('${t}')"]`); if(nav) nav.classList.add('active'); 
                    if(t==='attendance') setTimeout(()=>document.getElementById('scanner-input')?.focus(), 500); 
                    if(t==='dashboard') animateCounters(); 
                }, 
                openSidebar: () => { document.querySelector('.sidebar').classList.add('show'); document.querySelector('.sidebar-backdrop').classList.add('show'); }, 
                closeSidebar: () => { document.querySelector('.sidebar').classList.remove('show'); document.querySelector('.sidebar-backdrop').classList.remove('show'); } 
            },
            classroom: {
                createSection: async () => { await set(push(ref(db,'sections')), { name: sanitize(document.getElementById('new-section-name').value), teacherId: currentUser.uid }); Swal.fire('Created','','success'); },
                loadSections: () => onValue(ref(db,'sections'), s => { const e=document.getElementById('select-target-section'); const l=document.getElementById('my-sections-list'); e.innerHTML=''; if(l) l.innerHTML=''; s.forEach(c => { const v=c.val(); if(currentRole==='admin'||v.teacherId===currentUser.uid){ e.innerHTML+=`<option value="${c.key}">${v.name}</option>`; if(l && v.teacherId===currentUser.uid) l.innerHTML+=`<li class="list-group-item bg-dark text-white border-0">${v.name}</li>`; }}); }),
                loadStudentDropdown: () => { onValue(ref(db,'users'), s=>{ const sel = document.getElementById('excuse-student-select'); sel.innerHTML='<option value="">Select Student...</option>'; s.forEach(c=>{ const u=c.val(); if(u.role==='student') sel.innerHTML+=`<option value="${u.email}">${u.username||u.email}</option>`; }); }); },
                loadUnassigned: () => onValue(ref(db,'users'), s => { const list = document.getElementById('unassigned-list'); list.innerHTML = ''; s.forEach(c => { if(c.val().role === 'student' && !c.val().classId) list.innerHTML += `<tr><td>${c.val().email}</td><td><button class="btn btn-sm btn-success rounded-pill" onclick="app.classroom.assign('${c.key}')">Assign</button></td></tr>`; }); }),
                assign: async (uid) => { const sid = document.getElementById('select-target-section').value; if(!sid) return; await update(ref(db, 'users/'+uid), { classId: sid }); Swal.fire('Assigned', '', 'success'); },
                linkParent: async () => { const sEmail = document.getElementById('link-student-email').value; const pEmail = document.getElementById('link-parent-email').value; if(sEmail && pEmail) await app.utils.linkParentInternal(sEmail, pEmail); }
            },
            attendance: {
                scanner: null,
                startScanner: () => { 
                    const r=document.getElementById('reader'); if(!r||app.attendance.scanner) return; 
                    try {
                        app.attendance.scanner = new Html5Qrcode("reader"); 
                        app.attendance.scanner.start({facingMode:"environment"}, {fps:10, qrbox:{width:250,height:250}}, (t)=>{ 
                            document.getElementById('scan-result').innerHTML=`<span class="text-success">âœ… ${t}</span>`; 
                            new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(()=>{}); 
                            app.attendance.manualLogInternal(t); app.attendance.scanner.pause(); setTimeout(()=>app.attendance.scanner.resume(),2000); 
                        }, (e)=>{}).catch(()=>{Swal.fire('Error','Camera fail','error')}); 
                        document.getElementById('btn-start-scan').classList.add('d-none'); document.getElementById('btn-stop-scan').classList.remove('d-none'); 
                    } catch(e) { Swal.fire('Error', 'Library Error', 'error'); }
                },
                stopScanner: async () => { if(app.attendance.scanner) { await app.attendance.scanner.stop(); app.attendance.scanner.clear(); app.attendance.scanner=null; document.getElementById('btn-start-scan').classList.remove('d-none'); document.getElementById('btn-stop-scan').classList.add('d-none'); } },
                processScan: async () => { const i=document.getElementById('scanner-input'); const v=i.value.trim(); if(!v) return; const q=query(ref(db,'users'),orderByChild('email'),equalTo(v)); const s=await get(q); let e=v; if(!s.exists()) { const u=await get(ref(db,'users/'+v)); if(u.exists()) e=u.val().email; else { document.getElementById('scan-result').innerHTML='<span class="text-danger">Not Found</span>'; return; } } const d=document.getElementById('manual-date').value; const t=d?new Date(d).getTime():Date.now(); await push(ref(db,'attendance'),{email:e, timestamp:t, status:new Date(t).getHours()>=8?'Late':'Present', recordedBy:currentUser.uid}); document.getElementById('scan-result').innerHTML=`<span class="text-success">Log: ${e}</span>`; i.value=''; i.focus(); },
                manualLogInternal: async (e) => { if(!isOnline) { addToQueue('attendance',{email:e,timestamp:Date.now(),status:'Pending',recordedBy:currentUser.uid}); return; } await push(ref(db,'attendance'), { email:e, timestamp:Date.now(), status: new Date().getHours()>=8?'Late':'Present', recordedBy:currentUser.uid }); },
                loadRecent: () => onValue(query(ref(db,'attendance'), orderByChild('timestamp')), s => { const l=document.getElementById('recent-attendance'); l.innerHTML=''; const d=[]; s.forEach(c=>d.push(c.val())); d.reverse().slice(0,20).forEach(i=>l.innerHTML+=`<li class="list-group-item bg-transparent text-white border-bottom border-secondary small d-flex justify-content-between"><span>${i.email}</span><span class="badge ${i.status==='Late'?'bg-warning':'bg-success'}">${i.status}</span></li>`); }),
                exportSF2: () => { Swal.fire({toast:true, icon:'info', title:'Exporting CSV...', position:'top-end'}); }
            },
            discipline: { submitReport: async () => { await push(ref(db,'incidents'), { severity: document.getElementById('inc-severity').value, studentEmail: document.getElementById('inc-student-email').value, description: sanitize(document.getElementById('inc-desc').value), timestamp: Date.now() }); Swal.fire('Reported','','success'); }, loadIncidents: () => onValue(ref(db,'incidents'), s=>{ const l=document.getElementById('incident-list'); l.innerHTML=''; s.forEach(c=>{ const i=c.val(); l.innerHTML+=`<div class="card p-3 incident-card severity-${i.severity} animate-in"><strong>${i.severity}</strong><p class="mb-0">${i.description}</p><small class="text-muted">${i.studentEmail}</small></div>`; }) }) },
            excuses: { 
                submit: async () => { const em=(currentRole==='teacher'||currentRole==='admin')?document.getElementById('excuse-student-select').value:document.getElementById('excuse-email-input').value; if(!em) return Swal.fire('Error','No student','error'); await push(ref(db,'excuses'), { studentEmail:em, date:document.getElementById('excuse-date').value, reason:document.getElementById('excuse-reason').value, note:sanitize(document.getElementById('excuse-note').value), status:'Pending', timestamp:Date.now() }); Swal.fire('Sent','','success'); },
                load: () => onValue(ref(db,'excuses'), s=>{ const l=document.getElementById('excuse-list'); l.innerHTML=''; s.forEach(c=>{ const v=c.val(); let show=false; if(currentRole==='teacher'||currentRole==='admin') show=true; if(currentRole==='student'&&v.studentEmail===currentUser.email) show=true; if(currentRole==='parent'&&v.studentEmail===(linkedChildEmail||'')) show=true; if(show) { let act=(currentRole==='teacher'&&v.status==='Pending')?`<div class="mt-2"><button class="btn btn-sm btn-success me-1" onclick="app.excuses.decide('${c.key}','Approved')">Approve</button><button class="btn btn-sm btn-danger" onclick="app.excuses.decide('${c.key}','Denied')">Deny</button></div>`:''; l.innerHTML+=`<div class="list-group-item bg-dark text-white border-secondary mb-2 rounded animate-in"><div class="d-flex justify-content-between"><strong>${v.studentEmail}</strong><span class="badge ${v.status==='Approved'?'bg-success':'bg-warning'}">${v.status}</span></div><small>${v.date} â€¢ ${v.reason}</small><p class="small text-muted mb-0">${v.note}</p>${act}</div>`; } }); }),
                decide: async (k,st) => { await update(ref(db,'excuses/'+k),{status:st}); Swal.fire('Updated',st,'success'); }
            },
            parent: { linkChild: async () => { const e=document.getElementById('parent-child-email').value; if(!e) return; await update(ref(db,'users/'+currentUser.uid),{linkedChild:e}); Swal.fire('Linked','','success'); app.parent.loadChild(e); }, loadChild: async (e) => { const em=e||(await get(ref(db,'users/'+currentUser.uid))).val().linkedChild; if(!em) return; linkedChildEmail=em; document.getElementById('parent-linker').classList.add('d-none'); document.getElementById('parent-stats').classList.remove('d-none'); let att=0,inc=0,pts=0; (await get(query(ref(db,'users'),orderByChild('email'),equalTo(em)))).forEach(x=>pts=x.val().points||0); (await get(ref(db,'attendance'))).forEach(x=>{if(x.val().email===em)att++}); (await get(ref(db,'incidents'))).forEach(x=>{if(x.val().studentEmail===em)inc++}); document.getElementById('p-att').innerText=att; document.getElementById('p-inc').innerText=inc; document.getElementById('p-pts').innerText=pts; } },
            admin: { 
                loadUsers: () => onValue(ref(db,'users'), s=>{ 
                    // Clear all lists first
                    document.getElementById('list-students').innerHTML = '';
                    document.getElementById('list-teachers').innerHTML = '';
                    document.getElementById('list-admins').innerHTML = '';
                    document.getElementById('list-parents').innerHTML = '';
                    
                    let cS=0, cT=0, cA=0, cP=0;
                    const term=document.getElementById('admin-search')?.value.toLowerCase()||'';
                    
                    s.forEach(c=>{ 
                        const u=c.val(); 
                        if(u.email.toLowerCase().includes(term)||(u.username||'').toLowerCase().includes(term)) {
                            // Row Template
                            const row = `<tr class="animate-in"><td><div class="fw-bold">${u.username||u.email}</div><small class="text-white-50">${u.email}</small></td><td><span class="badge bg-secondary">${u.role}</span></td><td><button class="btn btn-sm btn-outline-warning" onclick="app.admin.setRole('${c.key}','teacher')">T</button> <button class="btn btn-sm btn-outline-light" onclick="app.admin.setRole('${c.key}','student')">S</button> <button class="btn btn-sm btn-outline-danger" onclick="app.admin.setRole('${c.key}','admin')">A</button> <button class="btn btn-sm btn-outline-info" onclick="app.admin.setRole('${c.key}','parent')">P</button> <button class="btn btn-sm btn-success ms-1" title="Call" onclick="app.admin.callUser('${c.key}','${u.username||u.email}')"><i class="bi bi-telephone-fill"></i></button> ${u.role==='student' ? `<button class="btn btn-sm btn-primary ms-1" title="Link Parent" onclick="app.admin.linkParent('${c.key}','${u.email}')"><i class="bi bi-link"></i></button>` : ''}</td></tr>`;
                            
                            if(u.role==='student') { document.getElementById('list-students').innerHTML += row; cS++; }
                            else if(u.role==='teacher') { document.getElementById('list-teachers').innerHTML += row; cT++; }
                            else if(u.role==='admin') { document.getElementById('list-admins').innerHTML += row; cA++; }
                            else if(u.role==='parent') { document.getElementById('list-parents').innerHTML += row; cP++; }
                        }
                    });
                    
                    document.getElementById('count-student').innerText = cS;
                    document.getElementById('count-teacher').innerText = cT;
                    document.getElementById('count-admin').innerText = cA;
                    document.getElementById('count-parent').innerText = cP;
                }), 
                setRole: async (k,r) => { await update(ref(db,'users/'+k),{role:r}); Swal.fire('Role Updated',r,'success'); }, 
                filterUsers: () => app.admin.loadUsers(), 
                linkParent: async (sk, se) => { const {value:pe} = await Swal.fire({input:'text', inputLabel:`Parent for ${se}`}); if(pe) app.utils.linkParentInternal(se, pe); }, 
                callUser: async (tid, tname) => { const uSnap = await get(ref(db, 'users/' + currentUser.uid)); await push(ref(db, 'notifications/' + tid), { type: 'call', from: uSnap.val().username||'Admin', timestamp: Date.now() }); Swal.fire('Calling...', `Notifying ${tname}`, 'success'); },
                loadAudit: () => onValue(query(ref(db,'auditLogs'), orderByChild('timestamp')), s=>{ const l=document.getElementById('admin-audit-list'); if(l){l.innerHTML=''; const lg=[]; s.forEach(c=>lg.push(c.val())); lg.reverse().slice(0,20).forEach(x=>l.innerHTML+=`<li class="list-group-item bg-transparent text-white border-bottom border-secondary small py-2"><span class="text-info">${new Date(x.timestamp).toLocaleTimeString()}</span> <strong>${x.action}</strong> ${x.details}</li>`); } }) 
            },
            calendar: { render: () => { /* Logic same as v9 */ const m=calDate.getMonth(), y=calDate.getFullYear(); document.getElementById('calendar-month-display').innerText = new Date(y,m).toLocaleString('default',{month:'long',year:'numeric'}); const fd=new Date(y,m,1).getDay(), dim=new Date(y,m+1,0).getDate(); onValue(ref(db,'events'), s=>{ const evs=[]; s.forEach(c=>evs.push(c.val())); const g=document.getElementById('calendar-grid'); g.innerHTML=''; for(let i=0;i<fd;i++) g.innerHTML+=`<div class="col"></div>`; for(let i=1;i<=dim;i++) { const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; let h=''; evs.forEach(e=>{ if(e.dateStr===ds) h+=`<div class="calendar-event ${e.type==='Exam'?'evt-exam':(e.type==='Holiday'?'evt-holiday':'evt-activity')}">${e.title}</div>`; }); g.innerHTML+=`<div class="col calendar-day" onclick="app.calendar.expand('${ds}')"><span class="calendar-day-num">${i}</span>${h}</div>`; } }); }, expand: async (ds) => { if(currentRole==='student'){Swal.fire('Events','View Only','info');return;} const {value:t} = await Swal.fire({input:'text',title:`Add: ${ds}`}); if(t) { const {value:ty} = await Swal.fire({input:'select',inputOptions:{'Activity':'Activity','Exam':'Exam','Holiday':'Holiday'}}); await push(ref(db,'events'),{title:sanitize(t),dateStr:ds,type:ty}); app.calendar.render(); } }, nextMonth: () => { calDate.setMonth(calDate.getMonth()+1); app.calendar.render(); }, prevMonth: () => { calDate.setMonth(calDate.getMonth()-1); app.calendar.render(); } },
            teachernet: { send: async () => { const i=document.getElementById('teachernet-input'); if(i.value) { await push(ref(db,'teachernet_messages'), { text:sanitize(i.value), sender:currentUser.username||currentUser.email, uid:currentUser.uid, timestamp:Date.now(), avatar:currentUser.avatar||'' }); i.value=''; } }, load: () => onValue(query(ref(db,'teachernet_messages'), orderByChild('timestamp')), s=>{ const c=document.getElementById('teachernet-chat'); c.innerHTML=''; const m=[]; s.forEach(x=>m.push(x.val())); m.slice(-50).forEach(x=>{ const me=x.uid===currentUser.uid; c.innerHTML+=`<div class="chat-msg ${me?'mine':'theirs'} animate-in">${!me?`<div class="chat-avatar" style="background-image:url('${x.avatar||''}')"></div>`:''}<div class="chat-bubble"><small class="d-block text-white-50" style="font-size:0.7em">${x.sender}</small>${x.text}</div></div>`; }); c.scrollTop=c.scrollHeight; }) },
            student: { genID: (u) => { document.getElementById('my-id-name').innerText=u.username||'Student'; document.getElementById('my-id-email').innerText=u.email; new QRCode(document.getElementById('my-id-qrcode'), {text:currentUser.uid, width:120, height:120}); }, downloadID: () => { const c=document.querySelector('#my-id-qrcode canvas'); if(c) { const l=document.createElement('a'); l.download='ID.png'; l.href=c.toDataURL(); l.click(); } }, viewID: () => document.getElementById('student-id-view').classList.remove('d-none') },
            gamification: { loadLeaderboard: () => onValue(query(ref(db,'users'), orderByChild('points')), s=>{ const l=document.getElementById('leaderboard-list'); l.innerHTML=''; const a=[]; s.forEach(x=>a.push(x.val())); a.reverse().forEach((u,i)=>{ if(u.role==='student') l.innerHTML+=`<tr class="animate-in"><td><span class="badge bg-dark border">${i+1}</span></td><td>${u.email}</td><td class="text-info fw-bold">${u.points||0}</td><td>${u.points>100?'ðŸ†':''}</td></tr>`; }) }), givePoints: async () => { const e=document.getElementById('award-email').value; const p=+document.getElementById('award-amount').value; const s=await get(ref(db,'users')); let t=null; s.forEach(c=>{if(c.val().email===e)t=c.key}); if(t) { const o=s.val()[t].points||0; await update(ref(db,'users/'+t),{points:o+p}); Swal.fire('Sent','','success'); } } },
            messages: { post: async () => { await push(ref(db,'messages'), { title:document.getElementById('msg-title').value, body:sanitize(document.getElementById('msg-body').value), sender:currentUser.email, timestamp:Date.now() }); Swal.fire('Posted','','success'); }, load: () => onValue(ref(db,'messages'), s=>{ const l=document.getElementById('messages-list'); l.innerHTML=''; s.forEach(c=>{ const m=c.val(); l.innerHTML+=`<div class="card p-3 message-card animate-in"><h5>${m.title}</h5><p class="text-white-50">${m.body}</p><small class="text-muted">${new Date(m.timestamp).toLocaleDateString()}</small></div>`; }) }) },
            reports: { runAI: () => { /* Logic */ }, loadHeatmap: async () => { const s=await get(ref(db,'incidents')); const m=document.getElementById('behavior-heatmap'); if(m&&s.val()) { m.innerHTML=''; Object.values(s.val()).forEach(i=>{ m.innerHTML+=`<div class="heatmap-cell" style="background:${i.severity==='Critical'?'#ef4444':'#f59e0b'}" title="${i.description}"></div>`; }); } }, exportCSV: () => Swal.fire('Exporting...','','info') },
            charts: { init: () => { new Chart(document.getElementById('attendanceChart'), {type:'line', data:{labels:['M','T','W','T','F'], datasets:[{label:'Trend',data:[90,95,88,92,96],borderColor:'#6366f1',tension:0.4}]}}); } },
            settings: { 
                uploadAvatar: async () => { const f=document.getElementById('settings-avatar-file').files[0]; if(!f) return; const fd=new FormData(); fd.append('file',f); fd.append('upload_preset',CLOUDINARY_PRESET); try { Swal.fire({title:'Uploading...',didOpen:()=>Swal.showLoading()}); const r=await fetch(CLOUDINARY_URL,{method:'POST',body:fd}); const d=await r.json(); await update(ref(db,'users/'+currentUser.uid),{avatar:d.secure_url}); document.getElementById('nav-user-avatar').style.backgroundImage=`url(${d.secure_url})`; Swal.fire('Success','','success'); } catch(e){Swal.fire('Error','Upload fail','error')} }, 
                setLang: () => {}, 
                toggleNotif: () => {
                    if (Notification.permission !== "granted") {
                        Notification.requestPermission().then(p => {
                            if (p === "granted") Swal.fire('Enabled', 'You will receive calls even in background', 'success');
                        });
                    }
                }
            },
            notifications: { listen: (uid) => onValue(ref(db,'notifications/'+uid), s=>{ const d=s.val(); if(d) Object.entries(d).forEach(([k,v]) => { 
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); audio.play().catch(()=>{}); 
                if (Notification.permission === "granted") { new Notification("Incoming Call", { body: `Admin ${v.from} is calling you.` }); }
                Swal.fire({title:'Incoming Call',text:`${v.from} is calling`,icon:'info',backdrop:`rgba(0,0,0,0.8)`}); 
                remove(ref(db,'notifications/'+uid+'/'+k)); 
            }) }) },
            utils: { logAudit: (a,d) => push(ref(db,'auditLogs'),{action:a,details:d,user:currentUser.email,timestamp:Date.now()}), linkParentInternal: async (se, pe) => { const q=query(ref(db,'users'),orderByChild('email'),equalTo(pe)); const s=await get(q); if(!s.exists()) { Swal.fire('Error','Parent not found','error'); return; } const pk=Object.keys(s.val())[0]; await update(ref(db,'users/'+pk),{linkedChild:se}); Swal.fire('Linked!','','success'); app.utils.logAudit('LINK',`${pe}->${se}`); }, checkAutomation: () => {} }
        };

        onAuthStateChanged(auth, u => { if(u) app.init(u); else toggleView(false); });
    </script>
</body>
</html>
